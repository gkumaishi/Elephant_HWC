---
title: "Africa Bivariate Maps"
author: "Taylor Lockmann, Chris Kracha"
date: "2022-07-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Load in packages
library(tidyverse)
library(terra)
library(raster)

# Enter google filestream path including "HWC_data"
HWC_data <- "G:/.shortcut-targets-by-id/1YB-Hz3L-kWyiZMg2UM89GQkvqXyZUW1H/HWC_data"
```


# BASELINE/HISTORIC MAPPING

## CROPLAND

### Read in files
```{r}
# Read in the baseline land use and SDM
sdm <- rast(paste0(HWC_data, "/Wallace SDM Rasters/LQ/1981_2010/afel_historic_sdm.tif"))
lu <- rast(paste0(HWC_data, "/Geospatial Data/Chen_LULC_data/global_LULC_2015.tif"))
```

### SDM

#### SDM raster does not have an extent, so we're going to assign it (found by importing to QGIS)
```{r}
ext(sdm) <- c(-25.3584728410000011,
              77.5998600799999849,
              -40.4084724209999990,
              26.3831939790000014)
```

#### Re-project SDM to equal-area
```{r}
sdm_reproj_af <- sdm %>% 
  project(crs(lu))

plot(sdm_reproj_af)
```

#### Reclassify SDM
```{r}
baseline_sdm <- sdm_reproj_af
baseline_sdm[baseline_sdm >= 0 & baseline_sdm < 0.33] <- 10
baseline_sdm[baseline_sdm >= 0.33 & baseline_sdm < 0.66] <- 20
baseline_sdm[baseline_sdm >=0.66 & baseline_sdm <= 1] <- 30

plot(baseline_sdm)
```

### Land Use

#### Crop land use to africa
```{r}
lu_af <- crop(lu, sdm_reproj_af)
```

#### Reclassify baseline land use to cropland binary
We want cropland (category 5) to be 1, everything else to be 0
```{r}
baseline_cropland <- lu_af
baseline_cropland[baseline_cropland != 5] <- 0
baseline_cropland[baseline_cropland == 5] <- 1
plot(baseline_cropland)
```

#### Aggregate cropland binary
```{r}
factor <- ceiling(res(sdm_reproj_af)[1]/res(lu_af)[1])

baseline_cropland_agg <- terra::aggregate(x = baseline_cropland, fact = factor, fun = mean, na.rm = TRUE)

plot(baseline_cropland_agg)
```

#### Reclassify aggregated agriculture into 3 categories

```{r}
# Categories used to visualize baseline maps
cropland3categories <- rbind(c(0,0,0),
                        c(0,0.5,1),
                        c(0.5,1,2))

base_cropland_factor <- baseline_cropland_agg %>% 
  classify(cropland3categories, include.lowest = FALSE)

plot(base_cropland_factor)
```

### Add SDM and cropland

#### Make the SDM have the same resolution as the cropland
```{r}
baseline_sdm_resamp <- terra::resample(baseline_sdm, 
                                       base_cropland_factor, 
                                       method = "near")

plot(baseline_sdm_resamp)
```

#### Add the two layers together
```{r}
baseline_bivariate_afrotropics <- as.factor(baseline_sdm_resamp 
                                + base_cropland_factor)

baselineScale <- c( "#CABED0", "#BC7C8F", "#AE3A4E", "#89A1C8", "#806A8A", "#77324C", "#4885C1", "#435786", "#3F2949")

plot(baseline_bivariate_afrotropics, main = "Baseline SDM and Cropland", type = "classes", col = baselineScale)
```

#### Write the file to a .tif to export to QGIS
```{r}
writeRaster(baseline_bivariate_afrotropics, paste0(HWC_data, "/Geospatial Data/bivariate_outputs/afel_bivariate_baseline.tif"), overwrite = TRUE)
```



## URBAN

#### Reclassify values of the baseline year for urban
We want urban (category 5) to be 1, everything else to be 0
```{r}
baseline_urban <- lu_af
baseline_urban[baseline_urban != 6] <- 0
baseline_urban[baseline_urban == 6] <- 1
plot(baseline_urban)
```

#### Aggregate urban baseline
```{r}
factor <- ceiling(res(baseline_sdm)[1]/res(lu_af)[1])

baseline_urban_agg <- terra::aggregate(x = baseline_urban, fact = factor, fun = mean, na.rm = TRUE)

plot(baseline_urban_agg)
```

#### Reclassify to 3 categories
```{r}
# Categories used to visualize baseline maps
cropland3categories <- rbind(c(0,0,0),
                        c(0,0.5,1),
                        c(0.5,1,2))

base_urban_factor <- baseline_urban_agg %>% 
  classify(cropland3categories, include.lowest = FALSE)

plot(base_urban_factor)
```

#### Resample SDM to aggregated urban resolution
```{r}
baseline_sdm_resamp_urb <- terra::resample(baseline_sdm, 
                                       base_urban_factor, 
                                       method = "near")

plot(baseline_sdm_resamp_urb)
```

#### Add the two layers together
```{r}
baseline_bivariate_afrotropics_urban <- as.factor(baseline_sdm_resamp_urb + base_urban_factor)

baselineScale <- c( "#E6E6FA", "#BC7C8F", "#AE3A4E", "#89A1C8", "#806A8A", "#77324C", "#4885C1", "#435786", "#3F2949")

plot(baseline_bivariate_afrotropics_urban, main = "Baseline SDM and Urban", type = "classes", col = baselineScale)

```

#### Write the file to a .tif to export to QGIS
```{r}
writeRaster(baseline_bivariate_afrotropics_urban, paste0(HWC_data, "/Geospatial Data/bivariate_outputs/afel_urban_bivariate_baseline.tif"), overwrite = TRUE)
```




# FUTURE PROJECTIONS

## Year: 2041-2070, Scenario: SSP1/RCP2.6, GCM: GFDL

### Setup and read PROJECTED land use and SDM

#### Load in packages
```{r}
# Load in packages
library(tidyverse)
library(terra)
library(raster)
```

#### Read in the PROJECTED land use and SDM
```{r}
sdm_126_2050 <- rast(paste0(HWC_data, "/Wallace SDM Rasters/LQ/2041_2070/126/change_maps/afel_change_2041_2070_126_gfdl.tif"))
lu_126_2050 <- rast(paste0(HWC_data, "/Geospatial Data/Chen_LULC_data/SSP1_RCP26/global_SSP1_RCP26_2055.tif"))
```

### SDM

#### SDM raster does not have an extent, so we're going to assign it (found by importing to QGIS)
```{r}
ext(sdm_126_2050) <- c(-25.3584728410000011,
              77.5998600799999849,
              -40.4084724209999990,
              26.3831939790000014)
```


#### Plot to look at them
FOR SDM:
1 - decreasing suitability
2 - no change, not suitable
3 - no change, suitable
4 - increasing suitability
```{r}
plot(sdm_126_2050)
plot(lu_126_2050)
```
#### Re-project the SDM to have the same CRS as the land use
```{r}
sdm_126_2050_reproj_as <- sdm_126_2050 %>% 
  project(crs(lu_126_2050), method = "near")

plot(sdm_126_2050_reproj_as)
```

#### Reclassify values of the SDM Change map
In original:
1 - decreasing suitability
2 - no change, not suitable
3 - no change, suitable
4 - increasing suitability
Now:
Same, except reclassify 2 (no change, not suitable) as NA
```{r}
sdmChange3categories <- rbind(c(1,10), c(2,NA), c(3,30), c(4,40))

sdm_126_2050_reclass <- sdm_126_2050_reproj_as %>%
  classify(sdmChange3categories)

plot(as.factor(sdm_126_2050_reclass))
```

### Land Use

#### Crop land use to africa
```{r}
lu_126_2050_af <- crop(lu_126_2050, sdm_126_2050_reproj_as)
plot(lu_126_2050_af)
```

#### Reclassify values of the year 2055 for cropland
We want cropland (category 5) to be 1, everything else to be 0
```{r}
cropland_126_2050 <- lu_126_2050_af
cropland_126_2050[cropland_126_2050 != 5] <- 0
cropland_126_2050[cropland_126_2050 == 5] <- 1
plot(cropland_126_2050)
```

#### Aggregate cropland

```{r}
factor <- ceiling(res(sdm_126_2050_reclass)[1]/res(cropland_126_2050)[1])

cropland_126_2050_agg <- terra::aggregate(x = cropland_126_2050, fact = factor, fun = mean, na.rm = TRUE)

plot(cropland_126_2050_agg)
```
#### Reclassify cropland into 3 categories

```{r}
cropland3categories <- rbind(c(0,0,0),
                        c(0,0.5,1),
                        c(0.5,1,2))

cropland_126_2050_factor <- cropland_126_2050_agg %>% 
  classify(cropland3categories, include.lowest = FALSE)

plot(cropland_126_2050_factor)
```

### Add SDM and cropland

#### Make both of the rasters have the same resolution

```{r}
sdm_126_2050_resamp <- resample(sdm_126_2050_reclass, cropland_126_2050_factor, method = "near")

plot(as.factor(sdm_126_2050_resamp))
```

#### Raster math - Cropland change vs SDM change (SSP1/RCP2.6, 2055)
```{r}
sdm_change_ag_126_2050 <- as.factor(sdm_126_2050_resamp + cropland_126_2050_factor)
```

### Map and export final raster

####Map with colors
```{r}
sdmRYGscale <- c("pink", "tomato", "maroon", "#FFFF99", "goldenrod1", "dark orange", "pale green", "green", "dark green")

plot(sdm_change_ag_126_2050, main = "SDM Change and Cropland in 2055
     SSP1 RCP2.6", type = "classes", col = sdmRYGscale)

```

#### Write the file to a .tif to export to QGIS
```{r}
writeRaster(sdm_change_ag_126_2050, paste0(HWC_data, "/Geospatial Data/bivariate_outputs/afel_sdm_change_ag_126_2050.tif"), overwrite = TRUE)
```




## Year: 2041-2070, Scenario: SSP5/RCP8.5, GCM: GFDL

### Setup and read PROJECTED land use and SDM

#### Load in packages
```{r}
# Load in packages
library(tidyverse)
library(terra)
library(raster)
```

#### Read in the PROJECTED land use and SDM
```{r}
sdm_585_2050 <- rast(paste0(HWC_data, "/Wallace SDM Rasters/LQ/2041_2070/585/change_maps/afel_change_2041_2070_585_gfdl.tif"))
lu_585_2050 <- rast(paste0(HWC_data, "/Geospatial Data/Chen_LULC_data/SSP5_RCP85/global_SSP5_RCP85_2055.tif"))
```

### SDM

#### SDM raster does not have an extent, so we're going to assign it (found by importing to QGIS)
```{r}
ext(sdm_585_2050) <- c(-25.3584728410000011,
              77.5998600799999849,
              -40.4084724209999990,
              26.3831939790000014)
```


#### Plot to look at them
FOR SDM:
1 - decreasing suitability
2 - no change, not suitable
3 - no change, suitable
4 - increasing suitability
```{r}
plot(sdm_585_2050)
plot(lu_585_2050)
```
#### Re-project the SDM to have the same CRS as the land use
```{r}
sdm_585_2050_reproj_as <- sdm_585_2050 %>% 
  project(crs(lu_585_2050), method = "near")

plot(sdm_585_2050_reproj_as)
```

#### Reclassify values of the SDM Change map
In original:
1 - decreasing suitability
2 - no change, not suitable
3 - no change, suitable
4 - increasing suitability
Now:
Same, except reclassify 2 (no change, not suitable) as NA
```{r}
sdmChange3categories <- rbind(c(1,10), c(2,NA), c(3,30), c(4,40))

sdm_585_2050_reclass <- sdm_585_2050_reproj_as %>%
  classify(sdmChange3categories)

plot(as.factor(sdm_585_2050_reclass))
```

### Land Use

#### Crop land use to africa
```{r}
lu_585_2050_af <- crop(lu_585_2050, sdm_585_2050_reproj_as)
plot(lu_585_2050_af)
```

#### Reclassify values of the year 2055 for cropland
We want cropland (category 5) to be 1, everything else to be 0
```{r}
cropland_585_2050 <- lu_585_2050_af
cropland_585_2050[cropland_585_2050 != 5] <- 0
cropland_585_2050[cropland_585_2050 == 5] <- 1
plot(cropland_585_2050)
```

#### Aggregate cropland

```{r}
factor <- ceiling(res(sdm_585_2050_reclass)[1]/res(cropland_585_2050)[1])

cropland_585_2050_agg <- terra::aggregate(x = cropland_585_2050, fact = factor, fun = mean, na.rm = TRUE)

plot(cropland_585_2050_agg)
```
#### Reclassify cropland into 3 categories

```{r}
cropland3categories <- rbind(c(0,0,0),
                        c(0,0.5,1),
                        c(0.5,1,2))

cropland_585_2050_factor <- cropland_585_2050_agg %>% 
  classify(cropland3categories, include.lowest = FALSE)

plot(cropland_585_2050_factor)
```

### Add SDM and cropland

#### Make both of the rasters have the same resolution

```{r}
sdm_585_2050_resamp <- resample(sdm_585_2050_reclass, cropland_585_2050_factor, method = "near")

plot(as.factor(sdm_585_2050_resamp))
```

#### Raster math - Cropland change vs SDM change (SSP5/RCP8.5, 2055)
```{r}
sdm_change_ag_585_2050 <- as.factor(sdm_585_2050_resamp + cropland_585_2050_factor)
```
### Map and export final raster

#### Map with colors
```{r}
sdmRYGscale <- c("pink", "tomato", "maroon", "#FFFF99", "goldenrod1", "dark orange", "pale green", "green", "dark green")

plot(sdm_change_ag_585_2050, main = "SDM Change and Cropland in 2055
     SSP1 RCP2.6", type = "classes", col = sdmRYGscale)
```

#### Write the file to a .tif to export to QGIS
```{r}
writeRaster(sdm_change_ag_585_2050, paste0(HWC_data, "/Geospatial Data/bivariate_outputs/afel_bivariate_change_126_2080.tif"), overwrite = TRUE)
```




## Year: 2071-2100, Scenario: SSP1/RCP2.6, GCM: GFDL

### Setup and read PROJECTED land use and SDM

#### Load in packages
```{r}
library(tidyverse)
library(terra)
library(raster)
```
#### Read in land use and SDM
```{r}
sdm_126_2080 <- rast(paste0(HWC_data, "/Wallace SDM Rasters/LQ/2071_2100/126/afel_historic_2071_2100_126_change_sdm.tif"))
lu_126_2080 <- rast(paste0(HWC_data, "/Geospatial Data/Chen_LULC_data/SSP1_RCP26/global_SSP1_RCP26_2085.tif"))
```

### SDM

#### SDM raster does not have an extent, so we're going to assign it (found by importing to QGIS)
```{r}
ext(sdm_126_2080) <- c(-25.3584728410000011,
              77.5998600799999849,
              -40.4084724209999990,
              26.3831939790000014)
```


#### Plot to look at them (DIFFERENT SCALE)
FOR SDM:
-1 ?
0 ?
1 ?
```{r}
plot(sdm_126_2080)
plot(lu_126_2080)
```
#### Re-project the SDM to have the same CRS as the land use
```{r}
sdm_126_2080_reproj_as <- sdm_126_2080 %>% 
  project(crs(lu_126_2080), method = "near")

plot(sdm_126_2080_reproj_as)
```

#### Reclassify values of the SDM Change map
In original:
1 - decreasing suitability
2 - no change, not suitable
3 - no change, suitable
4 - increasing suitability
Now:
Same, except reclassify 2 (no change, not suitable) as NA
```{r}
sdmChange3categories <- rbind(c(-1,10), c(0,20),c(1,30))

sdm_126_2080_reclass <- sdm_126_2080_reproj_as %>%
  classify(sdmChange3categories)

plot(as.factor(sdm_126_2080_reclass))
```

### Land Use

#### Crop land use to africa
```{r}
lu_126_2080_af <- crop(lu_126_2080, sdm_126_2080_reproj_as)
plot(lu_126_2080_af)
```

#### Reclassify values of the year 2055 for cropland
We want cropland (category 5) to be 1, everything else to be 0
```{r}
cropland_126_2080 <- lu_126_2080_af
cropland_126_2080[cropland_126_2080 != 5] <- 0
cropland_126_2080[cropland_126_2080 == 5] <- 1
plot(cropland_126_2080)
```

#### Aggregate cropland

```{r}
factor <- ceiling(res(sdm_126_2080_reclass)[1]/res(cropland_126_2080)[1])

cropland_126_2080_agg <- terra::aggregate(x = cropland_126_2080, fact = factor, fun = mean, na.rm = TRUE)

plot(cropland_126_2080_agg)
```
#### Reclassify cropland into 3 categories

```{r}
cropland3categories <- rbind(c(0,0,0),
                        c(0,0.5,1),
                        c(0.5,1,2))

cropland_126_2080_factor <- cropland_126_2080_agg %>% 
  classify(cropland3categories, include.lowest = FALSE)

plot(cropland_126_2080_factor)
```

### Add SDM and cropland

#### Make both of the rasters have the same resolution

```{r}
sdm_126_2080_resamp <- resample(sdm_126_2080_reclass, cropland_126_2080_factor, method = "near")

plot(as.factor(sdm_126_2080_resamp))
```

#### Raster math - Cropland change vs SDM change (SSP1/RCP2.6, 2055)
```{r}
sdm_change_ag_126_2080 <- as.factor(sdm_126_2080_resamp + cropland_126_2080_factor)

```

### Map and export final raster
#### Map with colors

#### Write the file to a .tif to export to QGIS
```{r}
writeRaster(sdm_change_ag_126_2080, paste0(HWC_data, "/Geospatial Data/bivariate_outputs/afel_sdm_change_ag_126_2080.tif"), overwrite = TRUE)
```






## Year: 2071-2100, Scenario: SSP5/RCP8.5, GCM: GFDL

###Setup and read PROJECTED land use and SDM

#### Load packages
```{r}
# Load in packages
library(tidyverse)
library(terra)
library(raster)
```

#### Read in the PROJECTED land use and SDM
```{r}
sdm_585_2080 <- rast(paste0(HWC_data, "/Wallace SDM Rasters/LQ/2071_2100/585/afel_historic_2071_2100_585_change_sdm.tif"))
lu_585_2080 <- rast(paste0(HWC_data, "/Geospatial Data/Chen_LULC_data/SSP5_RCP85/global_SSP5_RCP85_2085.tif"))
```

### SDM

#### SDM raster does not have an extent, so we're going to assign it (found by importing to QGIS)
```{r}
ext(sdm_585_2080) <- c(-25.3584728410000011,
              77.5998600799999849,
              -40.4084724209999990,
              26.3831939790000014)
```


#### Plot to look at them (DIFFERENT SCALE)
FOR SDM:
-1 ?
0 ?
1 ?
```{r}
plot(sdm_585_2080)
plot(lu_585_2080)
```
#### Re-project the SDM to have the same CRS as the land use
```{r}
sdm_585_2080_reproj_as <- sdm_585_2080 %>% 
  project(crs(lu_585_2080), method = "near")

plot(sdm_585_2080_reproj_as)
```

#### Reclassify values of the SDM Change map
In original:
1 - decreasing suitability
2 - no change, not suitable
3 - no change, suitable
4 - increasing suitability
Now:
Same, except reclassify 2 (no change, not suitable) as NA
```{r}
sdmChange3categories <- rbind(c(-1,10), c(0,20),c(1,30))

sdm_585_2080_reclass <- sdm_585_2080_reproj_as %>%
  classify(sdmChange3categories)

plot(as.factor(sdm_585_2080_reclass))
```

### Land Use

#### Crop land use to africa
```{r}
lu_585_2080_af <- crop(lu_585_2080, sdm_585_2080_reproj_as)
plot(lu_585_2080_af)
```

#### Reclassify values of the year 2055 for cropland
We want cropland (category 5) to be 1, everything else to be 0
```{r}
cropland_585_2080 <- lu_585_2080_af
cropland_585_2080[cropland_585_2080 != 5] <- 0
cropland_585_2080[cropland_585_2080 == 5] <- 1
plot(cropland_585_2080)
```

#### Aggregate cropland

```{r}
factor <- ceiling(res(sdm_585_2080_reclass)[1]/res(cropland_585_2080)[1])

cropland_585_2080_agg <- terra::aggregate(x = cropland_585_2080, fact = factor, fun = mean, na.rm = TRUE)

plot(cropland_585_2080_agg)
```
#### Reclassify cropland into 3 categories

```{r}
cropland3categories <- rbind(c(0,0,0),
                        c(0,0.5,1),
                        c(0.5,1,2))

cropland_585_2080_factor <- cropland_585_2080_agg %>% 
  classify(cropland3categories, include.lowest = FALSE)

plot(cropland_585_2080_factor)
```

### Add SDM and cropland

#### Make both of the rasters have the same resolution

```{r}
sdm_585_2080_resamp <- resample(sdm_585_2080_reclass, cropland_585_2080_factor, method = "near")

plot(as.factor(sdm_585_2080_resamp))
```

#### Raster math - Cropland change vs SDM change (SSP5/RCP8.5, 2055)
```{r}
sdm_change_ag_585_2080 <- as.factor(sdm_585_2080_resamp + cropland_585_2080_factor)
```

### Map and export final raster

#### Map with Colors
```{r}
sdmRYGscale <- c("pink", "tomato", "maroon", "#FFFF99", "goldenrod1", "dark orange", "pale green", "green", "dark green")

plot(sdm_change_ag_585_2080, main = "SDM Change and Cropland in 2055
     SSP1 RCP2.6", type = "classes", col = sdmRYGscale)
```

#### Write the file to a .tif to export to QGIS
```{r}
writeRaster(sdm_change_ag_585_2080, paste0(HWC_data, "/Geospatial Data/bivariate_outputs/afel_bivariate_change_126_2080.tif"), overwrite = TRUE)
```





