---
title: "Baseline Pop Exploration"
author: "Mia Guarnieri"
date: "2022-11-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(terra)
library(sf)
library(tmap)
library(geos)
library(rnaturalearth)
library(rnaturalearthdata)
library(tidyterra)

#File path to the HWC_data folder

HWC_data <- "/Volumes/GoogleDrive/.shortcut-targets-by-id/1YB-Hz3L-kWyiZMg2UM89GQkvqXyZUW1H/HWC_data"
```

#Read in the data

```{r}
#Worldpop 2010

wp2010 <- rast(here(HWC_data, "/Geospatial Data/Pop_dens/fpop_data/ppp_2010_1km_Aggregated.tif"))

#SSP1
SSP1 <- rast(here(HWC_data, "/Geospatial Data/Pop_dens/fpop_data/FPOP_SSP1/FPOP_SSP1_2020.tif"))
 
#SSP2
SSP2 <- rast(here(HWC_data, "/Geospatial Data/Pop_dens/fpop_data/FPOP_SSP2/FPOP_SSP2_2020.tif"))

#SSP3
SSP3 <- rast(here(HWC_data, "/Geospatial Data/Pop_dens/fpop_data/FPOP_SSP3/FPOP_SSP3_2020.tif"))

#SSP4
SSP4 <- rast(here(HWC_data, "/Geospatial Data/Pop_dens/fpop_data/FPOP_SSP4/FPOP_SSP4_2020.tif"))

#SSP5
SSP5 <- rast(here(HWC_data, "/Geospatial Data/Pop_dens/fpop_data/FPOP_SSP5/FPOP_SSP5_2020.tif"))

#read in necessary data layers for the function

#read in lulc for reprojection
lulc <- rast(here(HWC_data, "/Geospatial Data/Chen_LULC_data/global_LULC_2015.tif"))
  
#read in a shapefile for Africa and rasterize it (to mask extent of population data)
  
africa <- vect(here(HWC_data, "/Geospatial Data/basemaps/africa_continent/africa_continent.shp")) %>% 
  project(lulc)
  
africa_rast <- rasterize(africa, lulc)
```



#Wrangling function

```{r}
top_pop <- function(x){
  
  #reproject the designated population raster
  popdens <- project(x, lulc)
  
  #mask pop density to africa extent
  popdens_africa <- mask(popdens, africa_rast)
  
  #aggregate pop density
  
  africa_popdens_agg <- terra::aggregate(popdens_africa, fact = 10, fun = sum, na.rm = TRUE)
}

```

```{r}
 #keep only the top decile (as in Di Minin et al.) - not running this for the time being
  
  #calculate deciles
  decs <- global(africa_popdens_agg, quantile, probs = seq(0, 1, 0.1), na.rm = TRUE)
  
  #save cutoff value for highest decile
  
  topdec <- decs$X90.
  
  #reclassify so that the upper decile is 1 and all other values are NA
  
  top10_pop <- africa_popdens_agg
  
  top10_pop[top10_pop < topdec] <- NA
  
  top10_pop[top10_pop >= topdec] <- 1
  
  return(top10_pop)
```


#Run the wrangling function

```{r}

ssp1_diff <- SSP1 - wp2010

ssp2_diff <- SSP2 - wp2010

ssp3_diff <- SSP3 - wp2010

ssp4_diff <- SSP4 - wp2010

ssp5_diff <- SSP5 - wp2010

```

#Plot

```{r}
#test plots for human population density layers

#create a basemap

basemap_africa <- ne_countries(
  continent = "Africa",
  scale = "medium", 
  returnclass = "sf") %>% 
  st_transform(crs = crs(SSP1_wrangled))  # make sure crs is same as raster

basemap_africa_vect <- basemap_africa %>% 
  vect()

#map pop density rasters

#combine all plots into one graphic
par(mfrow=c(2,3))

#SSP1
plot(basemap_africa_vect, col = "grey98")
plot(ssp1_diff, add = TRUE, col = "darkgreen")

#SSP2
plot(basemap_africa_vect, col = "grey98")
plot(ssp2_diff, add = TRUE, col = "darkseagreen4")

#SSP3
plot(basemap_africa_vect, col = "grey98")
plot(ssp3_diff, add = TRUE, col = "goldenrod1")

#SSP4
plot(basemap_africa_vect, col = "grey98")
plot(ssp4_diff, add = TRUE, col = "orange1")

#SSP5
plot(basemap_africa_vect, col = "grey98")
plot(ssp5_diff, add = TRUE, col = "orangered")

```

