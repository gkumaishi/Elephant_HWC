---
title: "Differenced Conflict"
author: "Mia Guarnieri"
date: "2022-12-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(terra)
library(sf)
library(tmap)
library(geos)
library(rnaturalearth)
library(rnaturalearthdata)
library(tidyterra)
library(kableExtra)

#File path to the HWC_data folder

HWC_data <- "/Users/mia/Library/CloudStorage/GoogleDrive-mguarnieri@ucsb.edu/My Drive/Arnhold Project/HWC_data"
```

#Differencing function

```{r}
rast_diff <- function(x){
  
  base <- rast(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/conflict_boundaries/wp2010_current_day_cb_raster.tif"))
  
  diff <- x - base
  
  return(diff)
}
```

#Create differenced rasters

##SSP1

```{r}
#read in rasters

ssp1_rcp26_2030 <- rast(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/conflict_boundary_rasters/SSP1_RCP26_2030.tif"))

ssp1_rcp26_2050 <- rast(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/conflict_boundary_rasters/SSP1_RCP26_2050.tif"))

ssp1_rcp26_2070 <- rast(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/conflict_boundary_rasters/SSP1_RCP26_2070.tif"))

#difference the rasters and save them

##saving function
saverast <- function(x){
  
  name <- paste0(deparse(substitute(x)), ".tif")
  
  writeRaster(x, filename = here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_rasters/", name), overwrite = TRUE)
}

ssp1_rcp26_2030_diff <- rast_diff(ssp1_rcp26_2030)
saverast(ssp1_rcp26_2030_diff)

ssp1_rcp26_2050_diff <- rast_diff(ssp1_rcp26_2050)
saverast(ssp1_rcp26_2050_diff)

ssp1_rcp26_2070_diff <- rast_diff(ssp1_rcp26_2070)
saverast(ssp1_rcp26_2070_diff)

```

##SSP2

```{r}
#read in rasters

ssp2_rcp45_2030 <- rast(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/conflict_boundary_rasters/SSP2_RCP45_2030.tif"))

ssp2_rcp45_2050 <- rast(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/conflict_boundary_rasters/SSP2_RCP45_2050.tif"))

ssp2_rcp45_2070 <- rast(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/conflict_boundary_rasters/SSP2_RCP45_2070.tif"))

#difference the rasters and save them

ssp2_rcp45_2030_diff <- rast_diff(ssp2_rcp45_2030)
saverast(ssp2_rcp45_2030_diff)

ssp2_rcp45_2050_diff <- rast_diff(ssp2_rcp45_2050)
saverast(ssp2_rcp45_2050_diff)

ssp2_rcp45_2070_diff <- rast_diff(ssp2_rcp45_2070)
saverast(ssp2_rcp45_2070_diff)

```

##SSP3

```{r}
#read in rasters

ssp3_rcp70_2030 <- rast(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/conflict_boundary_rasters/SSP3_RCP70_2030.tif"))

ssp3_rcp70_2050 <- rast(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/conflict_boundary_rasters/SSP3_RCP70_2050.tif"))

ssp3_rcp70_2070 <- rast(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/conflict_boundary_rasters/SSP3_RCP70_2070.tif"))

#difference the rasters and save them

ssp3_rcp70_2030_diff <- rast_diff(ssp3_rcp70_2030)
saverast(ssp3_rcp70_2030_diff)

ssp3_rcp70_2050_diff <- rast_diff(ssp3_rcp70_2050)
saverast(ssp3_rcp70_2050_diff)

ssp3_rcp70_2070_diff <- rast_diff(ssp3_rcp70_2070)
saverast(ssp3_rcp70_2070_diff)

```

##SSP4

```{r}
#read in rasters

ssp4_rcp60_2030 <- rast(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/conflict_boundary_rasters/SSP4_RCP60_2030.tif"))

ssp4_rcp60_2050 <- rast(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/conflict_boundary_rasters/SSP4_RCP60_2050.tif"))

ssp4_rcp60_2070 <- rast(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/conflict_boundary_rasters/SSP4_RCP60_2070.tif"))

#difference the rasters and save them

ssp4_rcp60_2030_diff <- rast_diff(ssp4_rcp60_2030)
saverast(ssp4_rcp60_2030_diff)

ssp4_rcp60_2050_diff <- rast_diff(ssp4_rcp60_2050)
saverast(ssp4_rcp60_2050_diff)

ssp4_rcp60_2070_diff <- rast_diff(ssp4_rcp60_2070)
saverast(ssp4_rcp60_2070_diff)
```

##SSP5

```{r}
#read in rasters

ssp5_rcp85_2030 <- rast(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/conflict_boundary_rasters/SSP5_RCP85_2030.tif"))

ssp5_rcp85_2050 <- rast(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/conflict_boundary_rasters/SSP5_RCP85_2050.tif"))

ssp5_rcp85_2070 <- rast(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/conflict_boundary_rasters/SSP5_RCP85_2070.tif"))

#difference the rasters and save them

ssp5_rcp85_2030_diff <- rast_diff(ssp5_rcp85_2030)
saverast(ssp5_rcp85_2030_diff)

ssp5_rcp85_2050_diff <- rast_diff(ssp5_rcp85_2050)
saverast(ssp5_rcp85_2050_diff)

ssp5_rcp85_2070_diff <- rast_diff(ssp5_rcp85_2070)
saverast(ssp5_rcp85_2070_diff)
```


#Polygonize difference rasters for visualization

```{r}

#polyline function

poly <- function(x){
  #first make it a spatvector
  current_cb_vect <- terra::as.polygons(x, trunc=TRUE, dissolve=TRUE, values=TRUE,
    na.rm=TRUE, na.all=FALSE, extent=FALSE)
  
  #then turn that into a polyline
  current_cb_line <- st_as_sf(current_cb_vect) %>% 
    st_cast("MULTILINESTRING")
  
  return(current_cb_line)
}

#ssp1

ssp1_2030_diff_poly <- poly(ssp1_rcp26_2030_diff)
ssp1_2050_diff_poly <- poly(ssp1_rcp26_2050_diff)
ssp1_2070_diff_poly <- poly(ssp1_rcp26_2070_diff)

#ssp2

ssp2_2030_diff_poly <- poly(ssp2_rcp45_2030_diff)
ssp2_2050_diff_poly <- poly(ssp2_rcp45_2050_diff)
ssp2_2070_diff_poly <- poly(ssp2_rcp45_2070_diff)

#ssp3

ssp3_2030_diff_poly <- poly(ssp3_rcp70_2030_diff)
ssp3_2050_diff_poly <- poly(ssp3_rcp70_2050_diff)
ssp3_2070_diff_poly <- poly(ssp3_rcp70_2070_diff)

#ssp4

ssp4_2030_diff_poly <- poly(ssp4_rcp60_2030_diff)
ssp4_2050_diff_poly <- poly(ssp4_rcp60_2050_diff)
ssp4_2070_diff_poly <- poly(ssp4_rcp60_2070_diff)

#ssp5

ssp5_2030_diff_poly <- poly(ssp5_rcp85_2030_diff)
ssp5_2050_diff_poly <- poly(ssp5_rcp85_2050_diff)
ssp5_2070_diff_poly <- poly(ssp5_rcp85_2070_diff)

#save polylines for use in GIS

#ssp1
st_write(ssp1_2030_diff_poly, dsn = here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_polylines/ssp1_rcp26_2030_diff.shp"), append = FALSE)

st_write(ssp1_2050_diff_poly, dsn = here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_polylines/ssp1_rcp26_2050_diff.shp"), append = FALSE)

st_write(ssp1_2070_diff_poly, dsn = here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_polylines/ssp1_rcp26_2070_diff.shp"), append = FALSE)

#ssp2

st_write(ssp2_2030_diff_poly, dsn = here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_polylines/ssp2_rcp45_2030_diff.shp"), append = FALSE)

st_write(ssp2_2050_diff_poly, dsn = here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_polylines/ssp2_rcp45_2050_diff.shp"), append = FALSE)

st_write(ssp2_2070_diff_poly, dsn = here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_polylines/ssp2_rcp45_2070_diff.shp"), append = FALSE)

#ssp3

st_write(ssp3_2030_diff_poly, dsn = here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_polylines/ssp3_rcp70_2030_diff.shp"), append = FALSE)

st_write(ssp3_2050_diff_poly, dsn = here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_polylines/ssp3_rcp70_2050_diff.shp"), append = FALSE)

st_write(ssp3_2070_diff_poly, dsn = here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_polylines/ssp3_rcp70_2070_diff.shp"), append = FALSE)

#ssp4

st_write(ssp4_2030_diff_poly, dsn = here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_polylines/ssp4_rcp60_2030_diff.shp"), append = FALSE)

st_write(ssp4_2050_diff_poly, dsn = here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_polylines/ssp4_rcp60_2050_diff.shp"), append = FALSE)

st_write(ssp4_2070_diff_poly, dsn = here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_polylines/ssp4_rcp60_2070_diff.shp"), append = FALSE)

#ssp5

st_write(ssp5_2030_diff_poly, dsn = here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_polylines/ssp5_rcp85_2030_diff.shp"), append = FALSE)

st_write(ssp5_2050_diff_poly, dsn = here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_polylines/ssp5_rcp85_2050_diff.shp"), append = FALSE)

st_write(ssp5_2070_diff_poly, dsn = here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_polylines/ssp5_rcp85_2070_diff.shp"), append = FALSE)


#test plot:
#create a basemap

basemap_africa <- ne_countries(
  continent = "Africa",
  scale = "medium", 
  returnclass = "sf") %>% 
  st_transform(crs = crs(ssp1_2030_diff_poly))  # make sure crs is same as raster

basemap_africa_vect <- basemap_africa %>% 
  vect()

#plot conflict boundaries

#pal <- c("darkgreen", "goldenrod", "orangered")


plot(basemap_africa_vect, col = "grey98")
plot(ssp1_2030_diff_poly, add = TRUE, legend = TRUE)

```

#Polygons

```{r savepol function}

savepol <- function(x){
  
  name <- paste0(deparse(substitute(x)), ".shp")
 
  writeVector(x, filename = here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_polygons/", name), overwrite = TRUE)
  
}

#SSP1

ssp1_rcp26_2050_diff_polygon <- rast(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_rasters/ssp1_rcp26_2050_diff.tif")) %>% 
  terra::as.polygons(trunc=TRUE, dissolve=TRUE, values=TRUE, na.rm=TRUE, na.all=FALSE, extent=FALSE)

savepol(ssp1_rcp26_2050_diff_polygon)

#SSP3

ssp3_rcp70_2050_diff_polygon <- rast(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_rasters/ssp3_rcp70_2050_diff.tif")) %>% 
  terra::as.polygons(trunc=TRUE, dissolve=TRUE, values=TRUE, na.rm=TRUE, na.all=FALSE, extent=FALSE)

savepol(ssp3_rcp70_2050_diff_polygon)

```


#Percent value calculations

##Read in the polyline and polygon files

Polylines:

```{r polylines}
#Polylines

#SSP1
ssp1_2030_lines <- read_sf(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_polylines/ssp1_rcp26_2030_diff.shp"))

ssp1_2050_lines <- read_sf(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_polylines/ssp1_rcp26_2050_diff.shp"))

ssp1_2070_lines <- read_sf(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_polylines/ssp1_rcp26_2070_diff.shp"))


#SSP2

ssp2_2030_lines <- read_sf(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_polylines/ssp2_rcp45_2030_diff.shp"))

ssp2_2050_lines <- read_sf(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_polylines/ssp2_rcp45_2050_diff.shp"))

ssp2_2070_lines <- read_sf(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_polylines/ssp2_rcp45_2070_diff.shp"))


#SSP3

ssp3_2030_lines <- read_sf(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_polylines/ssp3_rcp70_2030_diff.shp"))

ssp3_2050_lines <- read_sf(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_polylines/ssp3_rcp70_2050_diff.shp"))

ssp3_2070_lines <- read_sf(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_polylines/ssp3_rcp70_2070_diff.shp"))


#SSP4

ssp4_2030_lines <- read_sf(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_polylines/ssp4_rcp60_2030_diff.shp"))

ssp4_2050_lines <- read_sf(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_polylines/ssp4_rcp60_2050_diff.shp"))

ssp4_2070_lines <- read_sf(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_polylines/ssp4_rcp60_2070_diff.shp"))


#SSP5

ssp5_2030_lines <- read_sf(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_polylines/ssp5_rcp85_2030_diff.shp"))

ssp5_2050_lines <- read_sf(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_polylines/ssp5_rcp85_2050_diff.shp"))

ssp5_2070_lines <- read_sf(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_polylines/ssp5_rcp85_2070_diff.shp"))

```

Polygons:

```{r}
#Polygons

#SSP1

ssp1_2050_polygons <- vect(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_polygons/ssp1_rcp26_2050_diff_polygon.shp"))


#SSP3

ssp3_2050_polygons <- vect(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_polygons/ssp3_rcp70_2050_diff_polygon.shp"))

```

##Set up function for percentage area/length calculations

```{r}
perc_area_table <- function(x){
  
  cb_area_table <- x %>% 
    as.data.frame() %>% 
    mutate(area = expanse(x, unit = "m")) %>% 
    mutate(perc_area = (area/sum(area) * 100))
  
  return(cb_area_table)
}

perc_length_table <- function(x){
  
  colnames(x) = c("class", "geometry")
  
  cb_area_table <- x %>% 
    rowwise() %>%
    mutate(length = st_length(geometry)) %>%
    ungroup() %>%
    group_by(class) %>%
    summarize(length = as.numeric(sum(length))) %>%
    ungroup() %>% 
    as.data.frame() %>% 
    mutate(perc_length = (length/sum(length) * 100))
  
  return(cb_area_table)
}

```

##Run calculations

###Lines
```{r}

#SSP1
s1_2030_diff_table <- perc_length_table(ssp1_2030_lines)

s1_2050_diff_table <- perc_length_table(ssp1_2050_lines)

s1_2070_diff_table <- perc_length_table(ssp1_2070_lines)


#SSP2
s2_2030_diff_table <- perc_length_table(ssp2_2030_lines)

s2_2050_diff_table <- perc_length_table(ssp2_2050_lines)

s2_2070_diff_table <- perc_length_table(ssp2_2070_lines)


#SSP3
s3_2030_diff_table <- perc_length_table(ssp3_2030_lines)

s3_2050_diff_table <- perc_length_table(ssp3_2050_lines)

s3_2070_diff_table <- perc_length_table(ssp3_2070_lines)


#SSP4
s4_2030_diff_table <- perc_length_table(ssp4_2030_lines)

s4_2050_diff_table <- perc_length_table(ssp4_2050_lines)

s4_2070_diff_table <- perc_length_table(ssp4_2070_lines)


#SSP5
s5_2030_diff_table <- perc_length_table(ssp5_2030_lines)

s5_2050_diff_table <- perc_length_table(ssp5_2050_lines)

s5_2070_diff_table <- perc_length_table(ssp5_2070_lines)


#Combined table

conf_change_table <- cbind(
  s1_2030_diff_table$class, 
  
  s1_2030_diff_table$perc_length,
  s2_2030_diff_table$perc_length,
  s3_2030_diff_table$perc_length,
  s4_2030_diff_table$perc_length,
  s5_2030_diff_table$perc_length,
  
  s1_2050_diff_table$perc_length,
  s2_2050_diff_table$perc_length,
  s3_2050_diff_table$perc_length,
  s4_2050_diff_table$perc_length,
  s5_2050_diff_table$perc_length,
  
  s1_2070_diff_table$perc_length,
  s2_2070_diff_table$perc_length,
  s3_2070_diff_table$perc_length,
  s4_2070_diff_table$perc_length,
  s5_2070_diff_table$perc_length
  )

colnames(conf_change_table) = c(
  "Conflict Change", 
  
  "SSP1 2030", 
  "SSP2 2030",
  "SSP3 2030",
  "SSP4 2030",
  "SSP5 2030",
  
  "SSP1 2050",
  "SSP2 2050",
  "SSP3 2050",
  "SSP4 2050",
  "SSP5 2050",
  
  "SSP1 2070",
  "SSP2 2070",
  "SSP3 2070",
  "SSP4 2070",
  "SSP5 2070"
  )

write.csv(conf_change_table, file = here(HWC_data, "Data/Di Minin HWC", "conflict_change_lines_byyear.csv"), row.names=FALSE)
```

```{r}

conf_change_table <- read_csv(here(HWC_data, "Data/Di Minin HWC", "conflict_change_lines_byyear.csv"))

dec <- c(rep(2, each = 16))

align <- c(rep("c", each = 16))

conf_change_lines_nicetables <- conf_change_table %>%
  kable(digits = dec,
        escape = FALSE,
        align = align) %>% 
  kable_styling(full_width = FALSE, position = "center") %>% 
  add_header_above(c(" ", "2030" = 5, "2050" = 5, "2070" = 5), background = c("#a8e6cf", "#dcedc1", "#ffd3b6")) %>% 
  column_spec(2:6, background = "#a8e6cf") %>%
  column_spec(7:11, background = "#dcedc1") %>% 
  column_spec(12:16, background = "#ffd3b6")

conf_change_lines_nicetables

library(magick)

save_kable(conf_change_lines_nicetables, file = here("/Users/mia/Desktop/Fellowships/Arnhold HWC/conf_change_lines_table_byyear.jpeg"))

```

