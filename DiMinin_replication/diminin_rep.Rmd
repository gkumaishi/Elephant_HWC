---
title: "Replication of Di Minin 2021 Analysis"
author: "Mia Guarnieri"
date: '2022-10-11'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(terra)
library(sf)
library(tmap)
library(geos)

HWC_data <- "/Volumes/GoogleDrive/.shortcut-targets-by-id/1YB-Hz3L-kWyiZMg2UM89GQkvqXyZUW1H/HWC_data"
```

#Input data

##Range data

```{r}
#turn off spherical geometry to simplify joins, etc.
sf_use_s2(FALSE)

#savanna elephant range (filtered to only keep extant ranges)
sav <- read_sf(here(HWC_data, "/Geospatial Data/range_data/iucn_range_sav_elephant/data_0.shp")) %>% 
  filter(LEGEND %in% c("Extant (resident)", "Extant & Reintroduced (resident)"))

#savanna elephant range, geometry only (no other data)

sav_geom <- sav %>% 
  select(geometry)

#forest elephant range (filtered to only keep extant ranges)
forest <- read_sf(here(HWC_data, "/Geospatial Data/range_data/iucn_range_forest_elephant/data_0.shp")) %>% 
  filter(LEGEND %in% c("Extant (resident)", "Extant & Reintroduced (resident)"))

#combined range map for savanna and forest elephants
all_elephant_range <- rbind(sav, forest)
```

```{r}
#plot combined range
tm_shape(all_elephant_range) +
  tm_polygons(col = "LEGEND") +
  tmap_mode("view")

#plot savanna elephant range
tm_shape(sav_geom) +
  tm_polygons() +
  tmap_mode("view")
```


##World protected areas data

Di Minin et al. (2021) only included in their analysis IUCN categories Ia (Strict Nature Reserve), Ib (Wilderness Area), II (National Park), III (Natural Monument or Feature), and IV (Habitat/Species Management Area). Additionally, to prevent overestimation of the area coverage of protected areas caused by overlapping designations, Di Minin et al. merged polygons into a single layer. We will do the same here.

World protected area aata is divided into 3 sets of polygons and 3 sets of points which need to be merged together to create one polygon layer and one points layer for use.

```{r}
#turn off spherical geometry to simplify joins, etc.
sf_use_s2(FALSE)

#polygon layers

wpa_1_pol <- read_sf(here(HWC_data, "/Geospatial Data/protected_areas/WDPA_Africa_Oct2022_shp/WDPA_WDOECM_Oct2022_Public_AF_shp_0/WDPA_WDOECM_Oct2022_Public_AF_shp-polygons.shp")) 

wpa_2_pol <- read_sf(here(HWC_data, "/Geospatial Data/protected_areas/WDPA_Africa_Oct2022_shp/WDPA_WDOECM_Oct2022_Public_AF_shp_1/WDPA_WDOECM_Oct2022_Public_AF_shp-polygons.shp"))

wpa_3_pol <- read_sf(here(HWC_data, "/Geospatial Data/protected_areas/WDPA_Africa_Oct2022_shp/WDPA_WDOECM_Oct2022_Public_AF_shp_2/WDPA_WDOECM_Oct2022_Public_AF_shp-polygons.shp")) 

#combine polygon layers and filter for IUCN categories Ia (Strict Nature Reserve), Ib (Wilderness Area), II (National Park), III (Natural Monument or Feature), and IV (Habitat/Species Management Area)

wpa_all_polygons <- rbind(wpa_1_pol, wpa_2_pol, wpa_3_pol) %>% 
  filter(IUCN_CAT %in% c("Ia", "Ib", "II", "III", "IV"))

#merge polygons into a single layer

wpa_allpol_dissolved <- st_union(wpa_all_polygons, by_feature = FALSE) %>% 
  st_cast(to = "POLYGON")

#wpa polygons, geometry only - no other attributes

wpa_allpol_geom <- wpa_all_polygons %>% 
  select(geometry)

#merging overlapping polygons

parts <- st_cast(st_union(wpa_allpol_geom),"POLYGON")
wpa_allpolgeom_dissolved <- st_intersects(wpa_allpol_geom, parts)

#plot merged polygon layer

tm_shape(wpa_allpolgeom_dissolved) +
  tm_polygons() +
  tmap_mode("view")

#point data layers

wpa_1_point <- read_sf(here(HWC_data, "/Geospatial Data/protected_areas/WDPA_Africa_Oct2022_shp/WDPA_WDOECM_Oct2022_Public_AF_shp_0/WDPA_WDOECM_Oct2022_Public_AF_shp-points.shp"))

wpa_2_point <- read_sf(here(HWC_data, "/Geospatial Data/protected_areas/WDPA_Africa_Oct2022_shp/WDPA_WDOECM_Oct2022_Public_AF_shp_1/WDPA_WDOECM_Oct2022_Public_AF_shp-points.shp"))

wpa_3_point <- read_sf(here(HWC_data, "/Geospatial Data/protected_areas/WDPA_Africa_Oct2022_shp/WDPA_WDOECM_Oct2022_Public_AF_shp_2/WDPA_WDOECM_Oct2022_Public_AF_shp-points.shp"))

#combined points layer

wpa_all_points <- rbind(wpa_1_point, wpa_2_point, wpa_3_point)

#plot points layer

tm_shape(wpa_all_points) +
  tm_dots() +
  tmap_mode("view")

#plot polygon and point layers together
tm_shape(wpa_allpol_dissolved) +
  tm_polygons() +
tm_shape(wpa_all_points) +
  tm_dots() +
  tmap_mode("view")
```

#Creating extended range maps

From Di Minin et al: The elephant range maps and the protected area layer were intersected to select all protected areas that contain parts of lion and elephant range and/or were adjacent to the species-range maps. The identified protected areas were then merged with the species-range maps to create a new extended range layer 

```{r}
#protected areas that contain part of elephant range

wpa_intersect <- st_join(wpa_allpol_geom, sav_geom, join = st_intersects, left = FALSE)

#verification plot: sav range and intersection
tm_shape(wpa_intersect) +
  tm_polygons() +
tm_shape(sav_geom) +
  tm_polygons(col = "blue") +
  tmap_mode("view")

#protected areas that are adjacent to elephant range

wpa_adj <- st_join(wpa_allpol_geom, sav_geom, join = st_touches, left = FALSE)

#this join is returning no data, suggesting that there are no polygons that satisfy the st_touches function (i.e., no adjacent polygons)

#creating an extended range map - no data, just polygons

ext_range <- rbind(sav_geom, wpa_adj, wpa_intersect)

#verification plots: sav range and extended range map
tm_shape(ext_range) +
  tm_polygons() +
tm_shape(sav_geom) +
  tm_polygons(col = "blue") +
  tmap_mode("view")

tm_shape(ext_range) +
  tm_polygons() +
tm_shape(wpa_intersect) +
  tm_polygons(col = "blue")

tm_shape(ext_range) +
  tm_polygons()

#dissolving polygons into one layer

ext_range_dissolved <- st_union(ext_range)

tm_shape(ext_range_dissolved) +
  tm_polygons()
```


#Pressure Layers

Di Minin et al. only retained areas where human, cattle, and crop densities were in the first decile  (the decile with the highest human population, crop, and cattle densities). We will only be using human population and cropland measurements, as we aren't looking at lion conflict (cattle predation).

##Land cover data

```{r}
#load in the land use/ land cover data

lulc <- rast(here(HWC_data, "/Geospatial Data/Chen_LULC_data/global_LULC_2015.tif"))

#africa extent map

africa <- vect(here(HWC_data, "/Geospatial Data/basemaps/Africa_Boundaries/afr_g2014_2013_0.shp")) %>% 
  rasterize()

#crop lulc to africa extent

lulc_africa <- crop(lulc, africa)

#plot to confirm

tm_shape(lulc_africa) +
  tm_raster(col = levels(lulc_africa)) +
  tmap_mode("view")

```

##Human density data

```{r}

```

##Ranked pressures layer

2 - High risk: high human + crop density
1 - Med risk: high human OR crop density
0 - Low risk: NO high human and NO high crop density

#Conflict layer

Extended range map is buffered by 10 km and intersected with classified pressures layer

##Asessing validity

"Used Latin hypercube sampling, which is a form of sampling used to reduce the number of runs necessary for a Monte Carlo simulation to achieve a reasonably accurate random distribution67, to randomly vary 100 times the distance values between the extended range and human pressure maps. Specifically, we divided the low, moderate, high, and severe conflict lines into 100 m segments, calculated the minimum distance for each segment to human pressure within a 10, 20, and 30 km buffer distance from the edge of the extended range map layer, and then randomly varied that distance 100 times across ±10% of the value. We then averaged the resulting 100 randomly created distance values for each segment and identified which segments fell outside of the analyzed buffer distances of 10, 20, and 30 km. We tested for 20 and 30 km buffer distances, as we wanted to assess the variability of the fencing distance to different buffer sizes."
