---
title: "Conflict and SDM"
author: "Mia Guarnieri"
date: "2023-02-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(terra)
library(sf)
library(tmap)
library(geos)
library(rnaturalearth)
library(rnaturalearthdata)
library(tidyterra)
library(kableExtra)

#File path to the HWC_data folder

HWC_data <- "/Users/mia/Library/CloudStorage/GoogleDrive-mguarnieri@ucsb.edu/My Drive/Arnhold Project/HWC_data"
```

#Reclass conflict layers to be just increasing, decreasing, or no change

```{r}
#reclassify function
reclass_rast <- function(x){
  
  rast <- x
  
  rast[rast == 0] <- 0
  
  rast[rast > 0] <- 1
  
  rast[rast < 0] <- -1
  
  return (rast)

}


africa_bindiff_ssp1 <- rast(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_conflict/differenced_rasters_africa/diff_SSP1_RCP26_2050.tif")) %>% 
  reclass_rast()

africa_bindiff_ssp3 <- rast(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_conflict/differenced_rasters_africa/diff_SSP3_RCP70_2050.tif")) %>% 
  reclass_rast()

```

#Filter binary conflict layers and mask SDMs

Load in and reproject SDMs

```{r}
#read in and reproject SDMs
africa_sdm_ssp1 <- rast(here(HWC_data, "/Wallace SDM Rasters/LQ/2041_2070/126/change_maps/afel_change_2041_2070_126_gfdl.tif")) %>% 
  project(africa_bindiff_ssp1, method = "near")

africa_sdm_ssp3 <- rast(here(HWC_data, "/Wallace SDM Rasters/LQ/2041_2070/370/change_maps/afel_change_2041_2070_gfdl_370.tif")) %>% 
  project(africa_bindiff_ssp1, method = "near")
```


Mask SDM by conflict change

```{r}
#ssp 1

africa_sdm_masked_ssp1 <- mask(africa_sdm_ssp1, africa_bindiff_ssp1)

#ssp 3

africa_sdm_masked_ssp3 <- mask(africa_sdm_ssp3, africa_bindiff_ssp3)

```


##GRACE LOOK HERE
- read in conflict raster, any raster
- mask SDM by that conflict raster to get boundaries
- then do the next part (polygonizing)
- do that for each GCM for ssp1 and ssp3 in 2050


##Polygonize masked SDM rasters

```{r}
polygons <- function(x){
  
  pol <- x %>%
    terra::as.polygons(trunc=TRUE, dissolve=TRUE, values=TRUE, na.rm=TRUE, na.all=FALSE, extent=FALSE)
  
  name <- paste0(deparse(substitute(x)), ".shp")
 
  writeVector(pol, filename = here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/sdm_exploration_polygons/africa", name), overwrite = TRUE)
  
}

polygons(africa_sdm_masked_ssp1)
polygons(africa_sdm_masked_ssp3)

```

#Percent area calculations

1 = decreasing suitability
2 = no change, not suitable
3 = no change, suitable
4 = increasing suitability

```{r}

#set up the function

perc_area_table <- function(x){
  
  diff_pol <- read_sf(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/sdm_exploration_polygons/africa", x))
  
  colnames(diff_pol) = c("suitability_change", "geometry")
  
  table <- diff_pol %>% 
    as.data.frame() %>% 
    mutate(area = st_area(diff_pol, unit = "m")) %>% 
    mutate(perc_area = (area/sum(area) * 100)) %>% 
    select(suitability_change, perc_area)
  
  return(table)
}

#list all of the files

sdm_pol_list <- list.files(path = here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/sdm_exploration_polygons/africa"), pattern = '.shp')


#apply the area function over the list

sdm_area_list <- lapply(sdm_pol_list, perc_area_table)

sdm_conf_change_table_pol <- sdm_area_list %>% reduce(full_join, by = "suitability_change") %>% 
  units::drop_units()

colnames(sdm_conf_change_table_pol) = c("suitability", sdm_pol_list)

descriptor <- c("Decreasing Suitability", "No Change - Not Suitable", "No Change - Suitable", "Increasing")

sdm_conf_change_table_pol$suitability <- descriptor

#write.csv(sdm_conf_change_table_pol, file = here(HWC_data, "Data/Di Minin HWC", "sdm_conf_change_table_africa.csv"), row.names=FALSE)

```