---
title: "Maps"
author: "Mia Guarnieri"
date: "2023-02-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(terra)
library(sf)
library(tmap)
library(RColorBrewer)
library(rnaturalearth)
library(ggplot2)
library(kableExtra)


HWC_data <- "/Users/mia/Library/CloudStorage/GoogleDrive-mguarnieri@ucsb.edu/My Drive/Arnhold Project/HWC_data"
```

#Baseline Conflict Table

```{r}
#function for perent area calculation
perc_area_table <- function(x){
  
  pol <- x
  
  colnames(pol) = c("conflict_risk", "geometry")
  
  table <- pol %>% 
    as.data.frame() %>% 
    mutate(area = st_area(pol, unit = "m")) %>% 
    mutate(perc_area = (area/sum(area) * 100)) %>% 
    select(conflict_risk, perc_area)
  
  return(table)
}

#read in the polygons

africa_conflict <- read_sf(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/conflict_boundaries/conflict_boundary_polygons_africa/wp2010_current_day_cb_pols.shp"))

asia_conflict <- read_sf(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/conflict_boundaries/conflict_boundary_polygons_asia/asia_wp2010_current_day_cb_pol.shp"))

#run the function on the polygons

africa_conftable <- perc_area_table(africa_conflict)

colnames(africa_conftable) = c("conflict_risk", "Africa")

asia_conftable <- perc_area_table(asia_conflict)

colnames(asia_conftable) = c("conflict_risk", "Asia")

current_conftable <- full_join(africa_conftable, asia_conftable, by = "conflict_risk") %>%
  mutate(across(where(is.numeric), round, digits = 2)) %>% 
  units::drop_units()

colnames(current_conftable) = c("Conflict Risk", "Africa", "Asia")

#set font size to scale with value and bold font within each region

current_conftable[ ,2] <- lapply(current_conftable[ ,2], function(x) {
  
  cell_spec(x, 
            bold = T,
            font_size = spec_font_size(x, 
                               begin = 13),
            color = spec_color(x, 
                       end = 0.6, direction = -1))
})

current_conftable[ ,3] <- lapply(current_conftable[ ,3], function(x) {
  
  cell_spec(x, 
            bold = T,
            font_size = spec_font_size(x, 
                               begin = 13),
            color = spec_color(x, 
                       end = 0.6, direction = -1))
})


#table

current_conf_nicetable <- current_conftable %>%
  kable(escape = FALSE,
        align = c("c", "c", "c")) %>% 
  kable_styling(full_width = FALSE, position = "center") %>%
  column_spec(2, border_right = TRUE)
 
current_conf_nicetable

save_kable(current_conf_nicetable, file = here("/Users/mia/Desktop/Fellowships/Arnhold HWC/current_figures/current_conf_risk_nicetable.jpeg"), zoom = 2.5)

```


#Conflict Change Table

```{r}
africa_conf_change_table <- read_csv(here(HWC_data, "Data/Di Minin HWC", "conflict_change_polygons_byyear_africa.csv")) %>% 
  janitor::clean_names() %>% 
  arrange(conflict_change) %>% 
  mutate("conflict_change" = c("Strong Decrease", "Moderate Decrease", "No Change", "Moderate Increase", "Strong Increase")) %>% 
  select(conflict_change, ssp1_2050, ssp3_2050)


asia_conf_change_table <- read_csv(here(HWC_data, "Data/Di Minin HWC", "conflict_change_polygons_byyear_asia.csv")) %>% 
  janitor::clean_names() %>% 
  arrange(conflict_change) %>% 
  mutate("conflict_change" = c("Strong Decrease", "Moderate Decrease", "No Change", "Moderate Increase", "Strong Increase")) %>% 
  select(conflict_change, ssp1_2050, ssp3_2050)

combined_conf_change <- cbind(africa_conf_change_table, asia_conf_change_table[, 2:3])

colnames(combined_conf_change) = c("Conflict Change", "SSP 1 - RCP 2.6", "SSP 3 - RCP 7.0", "SSP 1 - RCP 2.6", "SSP 3 - RCP 7.0")

dec <- c(rep(2, each = 5))

align <- c(rep("c", each = 5))

conf_change_nicetable <- combined_conf_change %>%
  kable(digits = dec,
        escape = FALSE,
        align = align) %>% 
  kable_styling(full_width = FALSE, position = "center") %>% 
  add_header_above(c(" ", "African Elephant" = 2, "Asian Elephant" = 2), background = c("#ffd3b6", "#a8e6cf")) %>% 
  column_spec(2:3, background = "#a8e6cf") %>%
  column_spec(4:5, background = "#ffd3b6")

conf_change_nicetable

library(magick)

save_kable(conf_change_nicetable, file = here("/Users/mia/Desktop/Fellowships/Arnhold HWC/current_figures/combined_conf_change.jpeg"), zoom = 2.5)
```

Removing No Change category

```{r}
africa_conf_change_table <- read_csv(here(HWC_data, "Data/Di Minin HWC", "conflict_change_polygons_byyear_africa.csv")) %>% 
  janitor::clean_names() %>% 
  arrange(conflict_change) %>% 
  filter(conflict_change != 0) %>% 
  mutate("conflict_change" = c("Strong Decrease", "Moderate Decrease", "Moderate Increase", "Strong Increase")) %>% 
  select(conflict_change, ssp1_2050, ssp3_2050)


asia_conf_change_table <- read_csv(here(HWC_data, "Data/Di Minin HWC", "conflict_change_polygons_byyear_asia.csv")) %>% 
  janitor::clean_names() %>% 
  arrange(conflict_change) %>% 
  filter(conflict_change != 0) %>% 
  mutate("conflict_change" = c("Strong Decrease", "Moderate Decrease", "Moderate Increase", "Strong Increase")) %>% 
  select(conflict_change, ssp1_2050, ssp3_2050)


```


#Africa

##SDM Change vs Conflict Risk

Create the csv of values

```{r}

#load in conflict risk rasters for ssp1 and ssp3 in 2050

africa_s1conf <- rast(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/conflict_boundaries/conflict_boundary_rasters_africa/SSP1_RCP26_2050.tif"))

africa_s3conf <- rast(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/conflict_boundaries/conflict_boundary_rasters_africa/SSP3_RCP70_2050.tif"))


#load in rasters of SDM change and mask by conflict rasters

africa_sdm_ssp1 <- rast(here(HWC_data, "/Wallace SDM Rasters/LQ/2041_2070/126/change_maps/afel_change_2041_2070_126_gfdl.tif")) %>% 
  project(africa_s1conf, method = "near") %>% 
  mask(africa_s1conf)

africa_sdm_ssp3 <- rast(here(HWC_data, "/Wallace SDM Rasters/LQ/2041_2070/370/change_maps/afel_change_2041_2070_gfdl_370.tif")) %>% 
  project(africa_s3conf, method = "near") %>% 
  mask(africa_s3conf)


#stack the corresponding conflict and sdm rasters

africa_s1_stack <- c(africa_s1conf, africa_sdm_ssp1)

africa_s3_stack <- c(africa_s3conf, africa_sdm_ssp3)


#extract pixel values from the raster stack and set column names

africa_s1_ext <- values(africa_s1_stack, dataframe = TRUE, na.rm = TRUE)

colnames(africa_s1_ext) = c("conflict_risk", "suitability_change")

africa_s3_ext <- values(africa_s3_stack, dataframe = TRUE, na.rm = TRUE)

colnames(africa_s3_ext) = c("conflict_risk", "suitability_change")


#create summary tables for each ssp of counts/percentages

africa_s1change_summary <- africa_s1_ext %>% 
  group_by(conflict_risk, suitability_change) %>% 
  summarize(count = n()) %>% 
  mutate (percent = (count/sum(africa_s1change_summary$count))*100)

colnames(africa_s1change_summary) = c("conflict_risk", "suitability_change", "count", "percent")

africa_s3change_summary <- africa_s3_ext %>% 
  group_by(conflict_risk, suitability_change) %>% 
  summarize(count = n()) %>% 
  mutate (percent = (count/sum(africa_s3change_summary$count))*100)

colnames(africa_s3change_summary) = c("conflict_risk", "suitability_change", "count", "percent")

#create wide tables of percentages only for joins and data vis

africa_s1change_wide <- africa_s1change_summary %>% 
  pivot_wider(
    names_from = conflict_risk, 
    values_from = c(count, percent)
  ) %>% 
  select(suitability_change, percent_0, percent_1, percent_2) %>% 
  mutate(total = rowSums(africa_s1change_wide[ ,2:4])) #have to run the rest of the functions first

colnames(africa_s1change_wide) = c("suitability_change", "s1_0", "s1_1", "s1_2", "s1_total")

africa_s3change_wide <- africa_s3change_summary %>% 
  pivot_wider(
    names_from = conflict_risk, 
    values_from = c(count, percent)
  ) %>% 
  select(suitability_change, percent_0, percent_1, percent_2) %>% 
  mutate(total = rowSums(africa_s3change_wide[ ,2:4])) #have to run the rest of the functions first

colnames(africa_s3change_wide) = c("suitability_change", "s3_0", "s3_1", "s3_2", "s3_total")

#join the tables

africa_sdm_conf_change <- full_join(africa_s1change_wide, africa_s3change_wide, by = "suitability_change")

descriptor <- c("Decreasing Suitability", "No Change - Not Suitable", "No Change - Suitable", "Increasing")

africa_sdm_conf_change$suitability_change <- descriptor

write.csv(africa_sdm_conf_change, file = here(HWC_data, "Data/Di Minin HWC", "sdm_conf_risk_percentage_table_africa.csv"), row.names=FALSE)

```

Turn the csv into a nice table

```{r}

library(kableExtra)

africa_data <- read_csv(here(HWC_data, "Data/Di Minin HWC", "sdm_conf_risk_percentage_table_africa.csv")) %>% 
  mutate(across(where(is.numeric), round, digits = 2))

africa_data_nums <- africa_data[1:4, ]

africa_data_nums[ ,2:4] <- lapply(africa_data_nums[ ,2:4], function(x) {
  
  cell_spec(x, 
            bold = T,
            color = spec_color(x, end = 0.6, direction = -1),
            font_size = spec_font_size(x, begin = 13))
})

africa_data_nums[ ,6:8] <- lapply(africa_data_nums[ ,6:8], function(x) {
  
  cell_spec(x, 
            bold = T,
            color = spec_color(x, end = 0.6, direction = -1),
            font_size = spec_font_size(x, begin = 13))
})

align <- c(rep("c", each = 9))

africa_sdm_conf_change_nicetable <- africa_data_nums %>%
  kable(escape = FALSE,
        align = align,
        caption = "<center><strong>Percentage of Range Boundary Within Each Climatic Suitability Change and Conflict Risk Category for African Elephants</strong></center>",
        col.names = c("Suitability Change", "Low", "Medium", "High", "Total", "Low", "Medium", "High", "Total")) %>% 
  kable_styling(full_width = FALSE, position = "center") %>% 
  add_header_above(c(" ", "SSP1 - RCP 2.6" = 4, "SP3 - RCP 7.0" = 4)) %>% 
  add_header_above(c(" ", "Conflict Risk" = 8)) %>% 
  column_spec(5, border_right = TRUE) 

#column_spec(6:10, background = "#ededed")

#background = c("#ededed", "white"

africa_sdm_conf_change_nicetable

#library(magick)

save_kable(africa_sdm_conf_change_nicetable, file = here("/Users/mia/Desktop/Fellowships/Arnhold HWC/current_figures/africa_sdm_conf_risk_nicetable.jpeg"), zoom = 2.5)

```


```{r}
#Applying the conditional formatting to the entire group rather than by conflict risk class

library(kableExtra)

africa_data <- read_csv(here(HWC_data, "Data/Di Minin HWC", "sdm_conf_risk_percentage_table_africa.csv")) %>% 
  mutate(across(where(is.numeric), round, digits = 2))

africa_rows <- africa_data[1:4, ]

africa_rows[ , 2:4] <- africa_rows[ , 2:4] %>% 
  mutate(across(where(is.numeric),function(x){cell_spec(x,
                                      bold = T,
                                      color = spec_color(x, end = 0.6, direction = -1),
                                      font_size = spec_font_size(x, begin = 13))}))

africa_rows[ , 6:8] <- africa_rows[ , 6:8] %>% 
  mutate(across(where(is.numeric),function(x){cell_spec(x,
                                      bold = T,
                                      color = spec_color(x, end = 0.6, direction = -1),
                                      font_size = spec_font_size(x, begin = 13))}))

align <- c(rep("c", each = 9))

africa_sdm_conf_change_nicetable <- africa_rows %>%
  kable(escape = FALSE,
        align = align,
        caption = "<center><strong>Percentage of Range Boundary Within Each Climatic Suitability Change and Conflict Risk Category for African Elephants</strong></center>",
        col.names = c("Suitability Change", "Low", "Medium", "High", "Total", "Low", "Medium", "High", "Total")) %>% 
  kable_styling(full_width = FALSE, position = "center") %>% 
  add_header_above(c(" ", "SSP1 - RCP 2.6" = 4, "SP3 - RCP 7.0" = 4)) %>% 
  add_header_above(c(" ", "Conflict Risk" = 8)) %>% 
  column_spec(5, border_right = TRUE) 

#column_spec(6:10, background = "#ededed")

#background = c("#ededed", "white"

africa_sdm_conf_change_nicetable

#library(magick)

#save_kable(africa_sdm_conf_change_nicetable, file = here("/Users/mia/Desktop/Fellowships/Arnhold HWC/current_figures/africa_sdm_conf_risk_nicetable.jpeg"), zoom = 2.5)
```



##SDM Change vs Conflict Change

Create the csv of values

```{r}
#load in conflict risk rasters for ssp1 and ssp3 in 2050

africa_s1confchange <- rast(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_conflict/differenced_rasters_africa/diff_SSP1_RCP26_2050.tif"))

africa_s3confchange <- rast(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_conflict/differenced_rasters_africa/diff_SSP3_RCP70_2050.tif"))

#load in rasters of SDM change and mask by conflict rasters

africa_sdm_ssp1 <- rast(here(HWC_data, "/Wallace SDM Rasters/LQ/2041_2070/126/change_maps/afel_change_2041_2070_126_gfdl.tif")) %>% 
  project(africa_s1confchange, method = "near") %>% 
  mask(africa_s1confchange)

africa_sdm_ssp3 <- rast(here(HWC_data, "/Wallace SDM Rasters/LQ/2041_2070/370/change_maps/afel_change_2041_2070_gfdl_370.tif")) %>% 
  project(africa_s3confchange, method = "near") %>% 
  mask(africa_s3confchange)

#stack the corresponding conflict and sdm rasters

africa_s1change_stack <- c(africa_s1confchange, africa_sdm_ssp1)

africa_s3change_stack <- c(africa_s3confchange, africa_sdm_ssp3)

#extract pixel values from the raster stack

africa_s1changeext <- values(africa_s1change_stack, dataframe = TRUE, na.rm = TRUE)

colnames(africa_s1changeext) = c("conflict_risk_change", "suitability_change")

africa_s3changeext <- values(africa_s3change_stack, dataframe = TRUE, na.rm = TRUE)

colnames(africa_s3changeext) = c("conflict_risk_change", "suitability_change")

#create summary tables for each ssp of counts/percentages

africa_s1change_summary <- africa_s1changeext %>% 
  group_by(conflict_risk_change, suitability_change) %>% 
  summarize(count = n()) %>% 
  mutate (percent = (count/sum(africa_s1change_summary$count))*100) #run the rest before this

colnames(africa_s1change_summary) = c("conflict_risk_change", "suitability_change", "count", "percent")

africa_s3change_summary <- africa_s3changeext %>% 
  group_by(conflict_risk_change, suitability_change) %>% 
  summarize(count = n()) %>% 
  mutate (percent = (count/sum(africa_s3change_summary$count))*100) #run the rest before this

colnames(africa_s3change_summary) = c("conflict_risk_change", "suitability_change", "count", "percent")

#create wide tables of percentages only for joins and data vis

africa_s1change_wide <- africa_s1change_summary %>% 
  pivot_wider(
    names_from = conflict_risk_change, 
    values_from = c(count, percent)) %>% 
  select(suitability_change, "percent_-1", percent_0, percent_1, percent_2)

colnames(africa_s1change_wide) = c("suitability_change", "s1_mod_dec", "s1_nc", "s1_mod_inc", "s1_strong_inc")

africa_s3change_wide <- africa_s3change_summary %>% 
  pivot_wider(
    names_from = conflict_risk_change, 
    values_from = c(count, percent)) %>% 
  select(suitability_change, "percent_-1", percent_0, percent_1, percent_2)

colnames(africa_s3change_wide) = c("suitability_change", "s3_mod_dec", "s3_nc", "s3_mod_inc", "s3_strong_inc")

#join the tables

africa_sdm_conf_change <- full_join(africa_s1change_wide, africa_s3change_wide, by = "suitability_change")

descriptor <- c("Decreasing Suitability", "No Change - Not Suitable", "No Change - Suitable", "Increasing")

africa_sdm_conf_change$suitability_change <- descriptor

write.csv(africa_sdm_conf_change, file = here(HWC_data, "Data/Di Minin HWC", "sdm_conf_change_percentage_table_africa.csv"), row.names=FALSE)

```

Turn the csv into a nice table

```{r}

asia_data <- read_csv(here(HWC_data, "Data/Di Minin HWC", "sdm_conf_change_percentage_table_asia.csv")) %>% 
  mutate(across(where(is.numeric), round, digits = 2))

asia_data_nums <- asia_data[1:4, ]


asia_data_nums[ ,2:10] <- lapply(asia_data_nums[ ,2:10], function(x) {
  
  cell_spec(x, 
            bold = T,
            font_size = spec_font_size(x, begin = 13),
            color = spec_color(x, end = 0.6, direction = -1))
})

align <- c(rep("c", each = 10))

asia_sdm_conf_change_nicetable <- asia_data_nums %>%
  kable(escape = FALSE,
        align = align,
        caption = "<center><strong>Percentage of Range Boundary Within Each Climatic Suitability Change and Conflict Risk Change Category for Asian Elephants</strong></center>",
        col.names = c("Suitability Change", "Moderate Decrease", "No Change", "Moderate Increase", "Strong Increase", "Strong Decrease", "Moderate Decrease", "No Change", "Moderate Increase", "Strong Increase")) %>% 
  kable_styling(full_width = FALSE, position = "center") %>% 
  add_header_above(c(" ", "SSP1 - RCP 2.6" = 4, "SP3 - RCP 7.0" = 5)) %>% 
  add_header_above(c(" ", "Conflict Risk Change" = 9)) %>% 
  column_spec(5, border_right = TRUE) 

#column_spec(6:10, background = "#ededed")

#background = c("#ededed", "white"

asia_sdm_conf_change_nicetable

library(magick)

save_kable(asia_sdm_conf_change_nicetable, file = here("/Users/mia/Desktop/Fellowships/Arnhold HWC/current_figures/asia_sdm_conf_change_nicetable.jpeg"), zoom = 2.5)
```



#Asia

##SDM Change vs Conflict Risk

Create the csv of values

```{r}

#load in conflict risk rasters for ssp1 and ssp3 in 2050

asia_s1conf <- rast(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/conflict_boundaries/conflict_boundary_rasters_asia/SSP1_RCP26_2050.tif"))

asia_s3conf <- rast(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/conflict_boundaries/conflict_boundary_rasters_asia/SSP3_RCP70_2050.tif"))


#load in rasters of SDM change and mask by conflict rasters

asia_sdm_ssp1 <- rast(here(HWC_data, "/Wallace SDM Rasters/asia/2011_2040/change_maps/change_2011_2040_126_gfdl.tif")) %>% 
  terra::project(asia_s1conf, method = "near") %>% 
  terra::mask(., asia_s1conf)

asia_sdm_ssp3 <- rast(here(HWC_data, "/Wallace SDM Rasters/asia/2011_2040/change_maps/change_2011_2040_370_gfdl.tif")) %>% 
  project(asia_s3conf, method = "near") %>% 
  mask(asia_s3conf)

#stack the corresponding conflict and sdm rasters

asia_s1_stack <- c(asia_s1conf, asia_sdm_ssp1)

asia_s3_stack <- c(asia_s3conf, asia_sdm_ssp3)


#extract pixel values from the raster stack

asia_s1ext <- values(asia_s1_stack, dataframe = TRUE, na.rm = TRUE)

colnames(asia_s1ext) = c("conflict_risk", "suitability_change")

asia_s3ext <- values(asia_s3_stack, dataframe = TRUE, na.rm = TRUE)

colnames(asia_s3ext) = c("conflict_risk", "suitability_change")


#create summary tables for each ssp of counts/percentages

asia_s1change_summary <- asia_s1ext %>% 
  group_by(conflict_risk, suitability_change) %>% 
  summarize(count = n()) %>% 
  mutate (percent = (count/sum(asia_s1change_summary$count))*100) #need to run the rest before this one

colnames(asia_s1change_summary) = c("conflict_risk", "suitability_change", "count", "percent")

asia_s3change_summary <- asia_s3ext %>% 
  group_by(conflict_risk, suitability_change) %>% 
  summarize(count = n()) %>% 
  mutate (percent = (count/sum(asia_s3change_summary$count))*100) #need to run the rest before this one

colnames(asia_s3change_summary) = c("conflict_risk", "suitability_change", "count", "percent")

#create wide tables of percentages only for joins and data vis

asia_s1change_wide <- asia_s1change_summary %>% 
  pivot_wider(
    names_from = conflict_risk, 
    values_from = c(count, percent)
  ) %>% 
  select(suitability_change, percent_0, percent_1, percent_2) %>% 
  mutate(total = rowSums(asia_s1change_wide[ ,2:4], na.rm = TRUE)) #need to run the rest before this line

colnames(asia_s1change_wide) = c("suitability_change", "s1_0", "s1_1", "s1_2", "s1_total")

asia_s3change_wide <- asia_s3change_summary %>% 
  pivot_wider(
    names_from = conflict_risk, 
    values_from = c(count, percent)
  ) %>% 
  select(suitability_change, percent_0, percent_1, percent_2) %>% 
  mutate(total = rowSums(asia_s3change_wide[ ,2:4]))  #need to run the rest before this line

colnames(asia_s3change_wide) = c("suitability_change", "s3_0", "s3_1", "s3_2", "s3_total")

#join the tables

asia_sdm_conf_change <- full_join(asia_s1change_wide, asia_s3change_wide, by = "suitability_change")

descriptor <- c("Decreasing Suitability", "No Change - Not Suitable", "No Change - Suitable", "Increasing")

asia_sdm_conf_change$suitability_change <- descriptor

write.csv(asia_sdm_conf_change, file = here(HWC_data, "Data/Di Minin HWC", "sdm_conf_risk_percentage_table_asia.csv"), row.names=FALSE)

```

Turn the csv into a nice table

```{r}

library(kableExtra)

asia_data <- read_csv(here(HWC_data, "Data/Di Minin HWC", "sdm_conf_risk_percentage_table_asia.csv")) %>% 
  mutate(across(where(is.numeric), round, digits = 2))

asia_data_nums <- asia_data[1:4, ]

asia_data_nums[ ,2:4] <- lapply(asia_data_nums[ ,2:4], function(x) {
  
  cell_spec(x, 
            bold = T,
            color = spec_color(x, end = 0.6, direction = -1),
            font_size = spec_font_size(x, begin = 13))
})

asia_data_nums[ ,6:8] <- lapply(asia_data_nums[ ,6:8], function(x) {
  
  cell_spec(x, 
            bold = T,
            color = spec_color(x, end = 0.6, direction = -1),
            font_size = spec_font_size(x, begin = 13))
})

align <- c(rep("c", each = 9))

asia_sdm_conf_change_nicetable <- asia_data_nums %>%
  kable(escape = FALSE,
        align = align,
        caption = "<center><strong>Percentage of Range Boundary Within Each Climatic Suitability Change and Conflict Risk Category for Asian Elephants</strong></center>",
        col.names = c("Suitability Change", "Low", "Medium", "High", "Total", "Low", "Medium", "High", "Total")) %>% 
  kable_styling(full_width = FALSE, position = "center") %>% 
  add_header_above(c(" ", "SSP1 - RCP 2.6" = 4, "SP3 - RCP 7.0" = 4)) %>% 
  add_header_above(c(" ", "Conflict Risk" = 8)) %>% 
  column_spec(5, border_right = TRUE) 

#column_spec(6:10, background = "#ededed")

#background = c("#ededed", "white"

asia_sdm_conf_change_nicetable

#library(magick)

save_kable(asia_sdm_conf_change_nicetable, file = here("/Users/mia/Desktop/Fellowships/Arnhold HWC/current_figures/asia_sdm_conf_risk_nicetable.jpeg"), zoom = 2.5)

```


##SDM Change vs Conflict Change

Create the csv of values

```{r}
#load in conflict risk rasters for ssp1 and ssp3 in 2050

asia_s1confchange <- rast(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_conflict/differenced_rasters_asia/diff_SSP1_RCP26_2050.tif"))

asia_s3confchange <- rast(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/differenced_conflict/differenced_rasters_asia/diff_SSP3_RCP70_2050.tif"))

#load in rasters of SDM change and mask by conflict rasters

asia_sdm_ssp1 <- rast(here(HWC_data, "/Wallace SDM Rasters/asia/2011_2040/change_maps/change_2011_2040_126_gfdl.tif")) %>% 
  terra::project(asia_s1confchange, method = "near") %>% 
  terra::mask(., asia_s1confchange)

asia_sdm_ssp3 <- rast(here(HWC_data, "/Wallace SDM Rasters/asia/2011_2040/change_maps/change_2011_2040_370_gfdl.tif")) %>% 
  terra::project(asia_s3confchange, method = "near") %>% 
  terra::mask(., asia_s3confchange)

#stack the corresponding conflict and sdm rasters

asia_s1change_stack <- c(asia_s1confchange, asia_sdm_ssp1)

asia_s3change_stack <- c(asia_s3confchange, asia_sdm_ssp3)

#extract pixel values from the raster stack

asia_s1changeext <- values(asia_s1change_stack, dataframe = TRUE, na.rm = TRUE)

colnames(asia_s1changeext) = c("conflict_risk_change", "suitability_change")

asia_s3changeext <- values(asia_s3change_stack, dataframe = TRUE, na.rm = TRUE)

colnames(asia_s3changeext) = c("conflict_risk_change", "suitability_change")

#create summary tables for each ssp of counts/percentages

asia_s1change_summary <- asia_s1changeext %>% 
  group_by(conflict_risk_change, suitability_change) %>% 
  summarize(count = n()) %>% 
  mutate (percent = (count/sum(asia_s1change_summary$count))*100)

colnames(asia_s1change_summary) = c("conflict_risk_change", "suitability_change", "count", "percent")

asia_s3change_summary <- asia_s3changeext %>% 
  group_by(conflict_risk_change, suitability_change) %>% 
  summarize(count = n()) %>% 
  mutate (percent = (count/sum(asia_s3change_summary$count))*100)

colnames(asia_s3change_summary) = c("conflict_risk_change", "suitability_change", "count", "percent")

#create wide tables of percentages only for joins and data vis

asia_s1change_wide <- asia_s1change_summary %>% 
  pivot_wider(
    names_from = conflict_risk_change, 
    values_from = c(count, percent)
  ) %>% 
  select(suitability_change, "percent_-1", percent_0, percent_1, percent_2)

colnames(asia_s1change_wide) = c("suitability_change", "s1_mod_dec", "s1_nc", "s1_mod_inc", "s1_strong_inc")

asia_s3change_wide <- asia_s3change_summary %>% 
  pivot_wider(
    names_from = conflict_risk_change, 
    values_from = c(count, percent)
  ) %>% 
  select(suitability_change, "percent_-2", "percent_-1", percent_0, percent_1, percent_2)

colnames(asia_s3change_wide) = c("suitability_change", "s3_strong_dec", "s3_mod_dec", "s3_nc", "s3_mod_inc", "s3_strong_inc")

#join the tables

asia_sdm_conf_change <- full_join(asia_s1change_wide, asia_s3change_wide, by = "suitability_change")

descriptor <- c("Decreasing Suitability", "No Change - Not Suitable", "No Change - Suitable", "Increasing")

asia_sdm_conf_change$suitability_change <- descriptor

write.csv(asia_sdm_conf_change, file = here(HWC_data, "Data/Di Minin HWC", "sdm_conf_change_percentage_table_asia.csv"), row.names=FALSE)

```

Turn the csv into a nice table

```{r}

asia_data <- read_csv(here(HWC_data, "Data/Di Minin HWC", "sdm_conf_change_percentage_table_asia.csv")) %>% 
  mutate(across(where(is.numeric), round, digits = 2))

asia_data_nums <- asia_data[1:4, ]


asia_data_nums[ ,2:10] <- lapply(asia_data_nums[ ,2:10], function(x) {
  
  cell_spec(x, 
            bold = T,
            font_size = spec_font_size(x, begin = 13),
            color = spec_color(x, end = 0.6, direction = -1))
})

align <- c(rep("c", each = 10))

asia_sdm_conf_change_nicetable <- asia_data_nums %>%
  kable(escape = FALSE,
        align = align,
        caption = "<center><strong>Percentage of Range Boundary Within Each Climatic Suitability Change and Conflict Risk Change Category for Asian Elephants</strong></center>",
        col.names = c("Suitability Change", "Moderate Decrease", "No Change", "Moderate Increase", "Strong Increase", "Strong Decrease", "Moderate Decrease", "No Change", "Moderate Increase", "Strong Increase")) %>% 
  kable_styling(full_width = FALSE, position = "center") %>% 
  add_header_above(c(" ", "SSP1 - RCP 2.6" = 4, "SP3 - RCP 7.0" = 5)) %>% 
  add_header_above(c(" ", "Conflict Risk Change" = 9)) %>% 
  column_spec(5, border_right = TRUE) 

#column_spec(6:10, background = "#ededed")

#background = c("#ededed", "white"

asia_sdm_conf_change_nicetable

library(magick)

save_kable(asia_sdm_conf_change_nicetable, file = here("/Users/mia/Desktop/Fellowships/Arnhold HWC/current_figures/asia_sdm_conf_change_nicetable.jpeg"), zoom = 2.5)
```



#Combined tables

##SDM change vs conflict risk

By column:

```{r}
library(kableExtra)

#Combine the datasets
africa_data <- read_csv(here(HWC_data, "Data/Di Minin HWC", "sdm_conf_risk_percentage_table_africa.csv")) %>% 
  mutate(across(where(is.numeric), round, digits = 2))

asia_data <- read_csv(here(HWC_data, "Data/Di Minin HWC", "sdm_conf_risk_percentage_table_asia.csv")) %>% 
  mutate(across(where(is.numeric), round, digits = 2))

combined_sdm_conf_risk <- full_join(africa_data, asia_data, by = "suitability_change")

#rename the columns so they make sense
colnames(combined_sdm_conf_risk) = c("suitability_change", "africa_s1_0", "africa_s1_1", "africa_s1_2", "africa_s1_total", "africa_s3_0", "africa_s3_1", "africa_s3_2", "africa_s3_total", "asia_s1_0", "asia_s1_1", "asia_s1_2", "asia_s1_total", "asia_s3_0", "asia_s3_1", "asia_s3_2", "asia_s3_total")

#create conditional formatting within each ssp

combined_data_nums <- combined_sdm_conf_risk[1:4, ]

combined_data_nums[ ,2:4] <- lapply(combined_data_nums[ ,2:4], function(x) {
  
  cell_spec(x, 
            bold = T,
            color = spec_color(x, end = 0.6, direction = -1),
            font_size = spec_font_size(x, begin = 13))
})

combined_data_nums[ ,6:8] <- lapply(combined_data_nums[ ,6:8], function(x) {
  
  cell_spec(x, 
            bold = T,
            color = spec_color(x, end = 0.6, direction = -1),
            font_size = spec_font_size(x, begin = 13))
})

combined_data_nums[ ,10:12] <- lapply(combined_data_nums[ ,10:12], function(x) {
  
  cell_spec(x, 
            bold = T,
            color = spec_color(x, end = 0.6, direction = -1),
            font_size = spec_font_size(x, begin = 13))
})

combined_data_nums[ ,14:16] <- lapply(combined_data_nums[ ,14:16], function(x) {
  
  cell_spec(x, 
            bold = T,
            color = spec_color(x, end = 0.6, direction = -1),
            font_size = spec_font_size(x, begin = 13))
})

align <- c(rep("c", each = 17))

combined_sdm_conf_risk_nicetable <- combined_data_nums %>%
  kable(escape = FALSE,
        align = align,
        caption = "<center><strong>Percentage of Range Boundary Within Each Climatic Suitability Change and Conflict Risk Category for African and Asian Elephants</strong></center>",
        col.names = c("Suitability Change", "Low", "Medium", "High", "Total", "Low", "Medium", "High", "Total", "Low", "Medium", "High", "Total", "Low", "Medium", "High", "Total")) %>% 
  kable_styling(full_width = FALSE, position = "center") %>% 
  add_header_above(c(" ", "SSP1 - RCP 2.6" = 4, "SP3 - RCP 7.0" = 4, "SSP1 - RCP 2.6" = 4, "SP3 - RCP 7.0" = 4)) %>% 
  add_header_above(c(" ", "African Elephant" = 8, "Asian Elephant" = 8)) %>% 
  add_header_above(c(" ", "Conflict Risk" = 16)) %>% 
  column_spec(c(5, 9, 13), border_right = TRUE) 

#column_spec(6:10, background = "#ededed")

#background = c("#ededed", "white"

combined_sdm_conf_risk_nicetable

save_kable(combined_sdm_conf_risk_nicetable, file = here("/Users/mia/Desktop/Fellowships/Arnhold HWC/current_figures/combined_sdm_conf_risk_nicetable.jpeg"), zoom = 2.5)
```


By SSP:

```{r}
library(kableExtra)

#Combine the datasets
africa_data <- read_csv(here(HWC_data, "Data/Di Minin HWC", "sdm_conf_risk_percentage_table_africa.csv")) %>% 
  mutate(across(where(is.numeric), round, digits = 2))

asia_data <- read_csv(here(HWC_data, "Data/Di Minin HWC", "sdm_conf_risk_percentage_table_asia.csv")) %>% 
  mutate(across(where(is.numeric), round, digits = 2))

combined_sdm_conf_risk <- full_join(africa_data, asia_data, by = "suitability_change")

#rename the columns so they make sense
colnames(combined_sdm_conf_risk) = c("suitability_change", "africa_s1_0", "africa_s1_1", "africa_s1_2", "africa_s1_total", "africa_s3_0", "africa_s3_1", "africa_s3_2", "africa_s3_total", "asia_s1_0", "asia_s1_1", "asia_s1_2", "asia_s1_total", "asia_s3_0", "asia_s3_1", "asia_s3_2", "asia_s3_total")

#create conditional formatting within each ssp

align <- c(rep("c", each = 17))

# define df min and max to scale colors and text
#africa
af_s1_cols <- combined_sdm_conf_risk[ , 2:4]

af_s1_min <- min(af_s1_cols)
af_s1_max <- max(af_s1_cols)

af_s3_cols <- combined_sdm_conf_risk[ , 6:8]

af_s3_min <- min(af_s3_cols)
af_s3_max <- max(af_s3_cols)

#asia
as_s1_cols <- combined_sdm_conf_risk[ , 10:12]
as_s1_cols[is.na(as_s1_cols)] <- 0


as_s1_min <- min(as_s1_cols)
as_s1_max <- max(as_s1_cols)

as_s3_cols <- combined_sdm_conf_risk[ , 14:16]

as_s3_min <- min(as_s3_cols)
as_s3_max <- max(as_s3_cols)



#set font size to scale with value and bold font within each ssp

combined_sdm_conf_risk[ ,2:4] <- lapply(combined_sdm_conf_risk[ ,2:4], function(x) {
  
  cell_spec(x, 
            bold = T,
            font_size = spec_font_size(x, 
                               begin = 13,
                               scale_from = c(af_s1_min, af_s1_max)),
            color = spec_color(x, 
                       end = 0.6, direction = -1,
                       scale_from = c(af_s1_min, af_s1_max)))
})

combined_sdm_conf_risk[ ,6:8] <- lapply(combined_sdm_conf_risk[ ,6:8], function(x) {
  
  cell_spec(x, 
            bold = T,
            font_size = spec_font_size(x, 
                               begin = 13,
                               scale_from = c(af_s3_min, af_s3_max)),
            color = spec_color(x, 
                       end = 0.6, direction = -1,
                       scale_from = c(af_s3_min, af_s3_max)))
})

combined_sdm_conf_risk[ ,10:12] <- lapply(combined_sdm_conf_risk[ ,10:12], function(x) {
  
  cell_spec(x, 
            bold = T,
            font_size = spec_font_size(x, 
                               begin = 13,
                               scale_from = c(as_s1_min, as_s1_max)),
            color = spec_color(x, 
                       end = 0.6, direction = -1,
                       scale_from = c(as_s1_min, as_s1_max)))
})

combined_sdm_conf_risk[ ,14:16] <- lapply(combined_sdm_conf_risk[ ,14:16], function(x) {
  
  cell_spec(x, 
            bold = T,
            font_size = spec_font_size(x, 
                               begin = 13,
                               scale_from = c(as_s3_min, as_s3_max)),
            color = spec_color(x, 
                       end = 0.6, direction = -1,
                       scale_from = c(as_s3_min, as_s3_max)))
})



#table

combined_sdm_conf_risk_nicetable <- combined_sdm_conf_risk %>%
  kable(escape = FALSE,
        align = align,
        caption = "<center><strong>Percentage of Range Boundary Within Each Climatic Suitability Change and Conflict Risk Category for African and Asian Elephants</strong></center>",
        col.names = c("Suitability Change", "Low", "Medium", "High", "Total", "Low", "Medium", "High", "Total", "Low", "Medium", "High", "Total", "Low", "Medium", "High", "Total")) %>% 
  kable_styling(full_width = FALSE, position = "center") %>%
  
  #scaling the color of the text within each ssp to the value of the number
  # #af_s1 columns
  # 
  # column_spec(
  #   column = 2, 
  #   ) %>% 
  # column_spec(
  #   column = 3, 
  #   color = spec_color(x = combined_sdm_conf_risk$africa_s1_1, 
  #                      end = 0.6, direction = -1,
  #                      scale_from = c(af_s1_min, af_s1_max))) %>% 
  # column_spec(
  #   column = 4, 
  #   color = spec_color(x = combined_sdm_conf_risk$africa_s1_2, 
  #                      end = 0.6, direction = -1,
  #                      scale_from = c(af_s1_min, af_s1_max))) %>% 
  
  #af_s3 columns
  
  # column_spec(
  #   column = 6, 
  #   ) %>% 
  # column_spec(
  #   column = 7, 
  #   color = spec_color(x = combined_sdm_conf_risk$africa_s3_1, 
  #                      end = 0.6, direction = -1,
  #                      scale_from = c(af_s3_min, af_s3_max))) %>% 
  # column_spec(
  #   column = 8, 
  #   color = spec_color(x = combined_sdm_conf_risk$africa_s3_2, 
  #                      end = 0.6, direction = -1,
  #                      scale_from = c(af_s3_min, af_s3_max))) %>% 
  
  #as_s1 columns
  
  # column_spec(
  #   column = 10, 
  #   ) %>% 
  # column_spec(
  #   column = 11, 
  #   color = spec_color(x = combined_sdm_conf_risk$asia_s1_1, 
  #                      end = 0.6, direction = -1,
  #                      scale_from = c(as_s1_min, as_s1_max))) %>% 
  # column_spec(
  #   column = 12, 
  #   color = spec_color(x = combined_sdm_conf_risk$asia_s1_2, 
  #                      end = 0.6, direction = -1,
  #                      scale_from = c(as_s1_min, as_s1_max))) %>% 
  
  #as_s3 columns
  
  # column_spec(
  #   column = 14, 
  #   ) %>% 
  # column_spec(
  #   column = 15, 
  #   color = spec_color(x = combined_sdm_conf_risk$asia_s3_1, 
  #                      end = 0.6, direction = -1,
  #                      scale_from = c(as_s3_min, as_s3_max))) %>% 
  # column_spec(
  #   column = 16, 
  #   color = spec_color(x = combined_sdm_conf_risk$asia_s3_2, 
  #                      end = 0.6, direction = -1,
  #                      scale_from = c(as_s3_min, as_s3_max))) %>% 
  add_header_above(c(" ", "SSP1 - RCP 2.6" = 4, "SP3 - RCP 7.0" = 4, "SSP1 - RCP 2.6" = 4, "SP3 - RCP 7.0" = 4)) %>% 
  add_header_above(c(" ", "African Elephant" = 8, "Asian Elephant" = 8)) %>% 
  add_header_above(c(" ", "Conflict Risk" = 16)) %>% 
  column_spec(c(5, 9, 13), border_right = TRUE)
 

combined_sdm_conf_risk_nicetable

save_kable(combined_sdm_conf_risk_nicetable, file = here("/Users/mia/Desktop/Fellowships/Arnhold HWC/current_figures/combined_sdm_conf_risk_nicetable_byssp.jpeg"), zoom = 2.5)
   
```


#SDM change vs conflict risk change

```{r}

africa_change_data <- read_csv(here(HWC_data, "Data/Di Minin HWC", "sdm_conf_change_percentage_table_africa.csv")) %>%
  mutate(across(where(is.numeric), round, digits = 2))

asia_change_data <- read_csv(here(HWC_data, "Data/Di Minin HWC", "sdm_conf_change_percentage_table_asia.csv")) %>%
  mutate(across(where(is.numeric), round, digits = 2))

combined_sdm_conf_change <- full_join(africa_change_data, asia_change_data, by = "suitability_change")

#rename the columns so they make sense
colnames(combined_sdm_conf_change) = c("suitability_change", "africa_s1_mod_dec", "africa_s1_nc", "africa_s1_mod_inc", "africa_s1_strong_inc", "africa_s3_mod_dec", "africa_s3_nc", "africa_s3_mod_inc", "africa_s3_strong_inc", "asia_s1_mod_dec", "asia_s1_nc", "asia_s1_mod_inc", "asia_s1_strong_inc", "asia_s3_strong_dec", "asia_s3_mod_dec", "asia_s3_nc", "asia_s3_mod_inc", "asia_s3_strong_inc")

#filter out no change
combined_sdm_conf_changeonly <- combined_sdm_conf_change %>% 
  select("suitability_change", "africa_s1_mod_dec", "africa_s1_mod_inc", "africa_s1_strong_inc", "africa_s3_mod_dec", "africa_s3_mod_inc", "africa_s3_strong_inc", "asia_s1_mod_dec", "asia_s1_mod_inc", "asia_s1_strong_inc", "asia_s3_strong_dec", "asia_s3_mod_dec", "asia_s3_mod_inc", "asia_s3_strong_inc")


#create conditional formatting within each ssp

combined_data_nums <- combined_sdm_conf_changeonly[1:4, ]

combined_data_nums[ ,2:4] <- lapply(combined_data_nums[ ,2:4], function(x) {
  
  cell_spec(x, 
            bold = T,
            color = spec_color(x, end = 0.6, direction = -1),
            font_size = spec_font_size(x, begin = 13))
})

combined_data_nums[ ,5:7] <- lapply(combined_data_nums[ ,5:7], function(x) {
  
  cell_spec(x, 
            bold = T,
            color = spec_color(x, end = 0.6, direction = -1),
            font_size = spec_font_size(x, begin = 13))
})

combined_data_nums[ ,8:10] <- lapply(combined_data_nums[ ,8:10], function(x) {
  
  cell_spec(x, 
            bold = T,
            color = spec_color(x, end = 0.6, direction = -1),
            font_size = spec_font_size(x, begin = 13))
})

combined_data_nums[ ,11:14] <- lapply(combined_data_nums[ ,11:14], function(x) {
  
  cell_spec(x, 
            bold = T,
            color = spec_color(x, end = 0.6, direction = -1),
            font_size = spec_font_size(x, begin = 13))
})

align <- c(rep("c", each = 14))

combined_sdm_conf_change_nicetable <- combined_data_nums %>%
  kable(escape = FALSE,
        align = align,
        caption = "<center><strong>Percentage of Range Boundary Within Each Climatic Suitability Change and Conflict Risk Change Category for African and Asian Elephants</strong></center>",
        col.names = c("Suitability Change", 
                      "Moderate Decrease", "Moderate Increase", "Strong Increase", 
                      "Moderate Decrease", "Moderate Increase", "Strong Increase", 
                      "Moderate Decrease", "Moderate Increase", "Strong Increase", 
                      "Strong Decrease", "Moderate Decrease", "Moderate Increase", "Strong Increase")) %>% 
  kable_styling(full_width = FALSE, position = "center") %>% 
  add_header_above(c(" ", "SSP1 - RCP 2.6" = 3, "SP3 - RCP 7.0" = 3, "SSP1 - RCP 2.6" = 3, "SP3 - RCP 7.0" = 4)) %>% 
  add_header_above(c(" ", "African Elephant" = 6, "Asian Elephant" = 7)) %>% 
  add_header_above(c(" ", "Conflict Risk Change" = 13)) %>% 
  column_spec(c(4, 7, 10), border_right = TRUE) 

#column_spec(6:10, background = "#ededed")

#background = c("#ededed", "white"

combined_sdm_conf_change_nicetable

save_kable(combined_sdm_conf_change_nicetable, file = here("/Users/mia/Desktop/Fellowships/Arnhold HWC/current_figures/combined_sdm_conf_risk_change_nicetable.jpeg"), zoom = 2.5)

```

