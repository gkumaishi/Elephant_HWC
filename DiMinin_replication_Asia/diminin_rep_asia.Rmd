---
title: "Replication of DiMinin 2021 Analysis - ASIA"
author: "Grace Kumaishi"
date: "1/12/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(terra)
library(sf)
library(tmap)
library(geos)
library(rnaturalearth)
library(rnaturalearthdata)
library(tidyterra)

#File path to the HWC_data folder

HWC_data <- "/Volumes/GoogleDrive/.shortcut-targets-by-id/1YB-Hz3L-kWyiZMg2UM89GQkvqXyZUW1H/HWC_data"
```

# Input data

## Range data

Species range data for Asian elephant, downloaded from IUCN redlist.

```{r}
# turn off spherical geometry to simplify joins, etc.
sf_use_s2(FALSE)

# Asian elephant range (filtered to keep only extant ranges)
asian_elephant_range <- read_sf(here(HWC_data, "/Data/Asian_Elephant/redlist_species_data/data_0.shp")) %>% 
  filter(LEGEND %in% c("Extant (resident)", "Extant & Reintroduced (resident)"))
```

```{r}
# plot range
tm_shape(asian_elephant_range) +
  tm_polygons(col = "LEGEND") +
  tmap_mode("view")
```

## World protected areas (WPAs) data

WPA data obtained from The World Database on Protected Areas (<http://www.protectedplanet.net>).

World protected area data is divided into 3 sets of polygons and 3 sets of points which need to be merged together to create one polygon layer and one points layer for use. We will be using only the polygons layer for analysis.

Di Minin et al. (2021) only included in their analysis IUCN categories Ia (Strict Nature Reserve), Ib (Wilderness Area), II (National Park), III (Natural Monument or Feature), and IV (Habitat/Species Management Area). Additionally, to prevent overestimation of the area coverage of protected areas caused by overlapping designations, Di Minin et al. merged polygons into a single layer. 

```{r}
indomalay_region <- read_sf(here(HWC_data, "/R_files/R_output_data/indomalay_region/indomalay_region.shp"))
```

```{r}
#turn off spherical geometry to simplify joins, etc.
sf_use_s2(FALSE)

#polygon layers

wpa_1_pol <- read_sf(here(HWC_data, "/Geospatial Data/protected_areas/WDPA_Asia_Jan2023_shp/WDPA_WDOECM_Jan2023_Public_AS_shp_0/WDPA_WDOECM_Jan2023_Public_AS_shp-polygons.shp"))

wpa_2_pol <- read_sf(here(HWC_data, "/Geospatial Data/protected_areas/WDPA_Asia_Jan2023_shp/WDPA_WDOECM_Jan2023_Public_AS_shp_1/WDPA_WDOECM_Jan2023_Public_AS_shp-polygons.shp"))

wpa_3_pol <- read_sf(here(HWC_data, "/Geospatial Data/protected_areas/WDPA_Asia_Jan2023_shp/WDPA_WDOECM_Jan2023_Public_AS_shp_2/WDPA_WDOECM_Jan2023_Public_AS_shp-polygons.shp"))

#combine polygon layers and filter for IUCN categories Ia (Strict Nature Reserve), Ib (Wilderness Area), II (National Park), III (Natural Monument or Feature), and IV (Habitat/Species Management Area)

wpa_all_polygons_uncropped <- rbind(wpa_1_pol, wpa_2_pol, wpa_3_pol) %>% 
  filter(IUCN_CAT %in% c("Ia", "Ib", "II", "III", "IV"))

# crop to indomalaya region
wpa_all_polygons <- st_crop(wpa_all_polygons_uncropped, indomalay_region)

#merge polygons into a single layer

wpa_allpol_dissolved <- st_union(wpa_all_polygons, by_feature = FALSE) %>% 
  st_cast(to = "POLYGON")

#wpa polygons, geometry only - no other attributes

wpa_allpol_geom <- wpa_all_polygons %>% 
  select(geometry)

#plot merged polygon layer

tm_shape(wpa_allpol_dissolved) +
  tm_polygons() +
  tmap_mode("view")
```

```{r}
# save the wpa shapefiles

st_write(wpa_all_polygons, dsn = here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/wpas_merged_filtered/wpa_allpol_filtered_ASIA.shp"))

st_write(wpa_allpol_dissolved, dsn = here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/wpas_filtered_dissolved/wpa_allpol_filtered_diss_ASIA.shp"))

#read them back in and check them

wpa_allpol <- read_sf(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/wpas_merged_filtered/wpa_allpol_filtered_ASIA.shp"))

wpa_dissolved <- read_sf(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/wpas_filtered_dissolved/wpa_allpol_filtered_diss_ASIA.shp"))
```

```{r point data}
#point data layers - not used in analysis, provided just for thoroughness

wpa_1_point <- read_sf(here(HWC_data, "/Geospatial Data/protected_areas/WDPA_Asia_Jan2023_shp/WDPA_WDOECM_Jan2023_Public_AS_shp_0/WDPA_WDOECM_Jan2023_Public_AS_shp-points.shp"))

wpa_2_point <- read_sf(here(HWC_data, "//Geospatial Data/protected_areas/WDPA_Asia_Jan2023_shp/WDPA_WDOECM_Jan2023_Public_AS_shp_1/WDPA_WDOECM_Jan2023_Public_AS_shp-points.shp"))

wpa_3_point <- read_sf(here(HWC_data, "/Geospatial Data/protected_areas/WDPA_Asia_Jan2023_shp/WDPA_WDOECM_Jan2023_Public_AS_shp_2/WDPA_WDOECM_Jan2023_Public_AS_shp-points.shp"))

#combined points layer

wpa_all_points <- rbind(wpa_1_point, wpa_2_point, wpa_3_point)

#plot points layer

tm_shape(wpa_all_points) +
  tm_dots() +
  tmap_mode("view")

#plot polygon and point layers together
tm_shape(wpa_allpol_dissolved) +
  tm_polygons() +
tm_shape(wpa_all_points) +
  tm_dots() +
  tmap_mode("view")
```

#Creating extended range maps

From Di Minin et al: The elephant range maps and the protected area layer were intersected to select all protected areas that contain parts of lion and elephant range and/or were adjacent to the species-range maps. The identified protected areas were then merged with the species-range maps to create a new extended range layer

```{r}
# Asian elephant

#protected areas that contain part of elephant range

wpa_intersect <- st_join(wpa_allpol_geom, asian_elephant_range, join = st_intersects, left = FALSE)

#verification plot: Asian elephant range and intersection

tm_shape(asian_elephant_range) +
  tm_polygons() +
tm_shape(wpa_intersect) +
  tm_polygons( col = "blue") +
tmap_mode("view")

#protected areas that are adjacent to elephant range

wpa_adj <- st_join(wpa_allpol_geom, asian_elephant_range, join = st_touches, left = FALSE)

#this join is returning no data, suggesting that there are no polygons that satisfy the st_touches function (i.e., no adjacent polygons)

#creating an extended range map - no data, just polygons
ext_range <- rbind(asian_elephant_range, wpa_intersect, wpa_adj)
```

```{r}
#save the shapefile

st_write(ext_range, dsn = here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/extended_range/extended_range_asia.shp"))

#read it back in and check it

ext_range_asia <- read_sf(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/extended_range/extended_range_asia.shp"))

tm_shape(ext_range) +
  tm_polygons(col = "blue") +
tm_shape(ext_range_asia) +
  tm_polygons() +
  tmap_mode("view")
```

# Pressure Layers

Di Minin et al. only retained areas where human, cattle, and crop densities were in the first decile (the decile with the highest human population, crop, and cattle densities). We will only be using human population and cropland measurements, as we aren't looking at lion conflict (cattle predation).

## Land cover data

Land classificationï¼š
1	Water
2	Forest
3	Grassland
4	Barren
5	Cropland - this is the one we will select for
6	Urban
7	Permanent snow and ice

```{r}
#turn off spherical geometry to simplify joins, etc.
sf_use_s2(FALSE)

#load in the land use/ land cover data

lulc <- rast(here(HWC_data, "/Geospatial Data/Chen_LULC_data/global_LULC_2015.tif"))

# read in shapefile for Indomalaya and rasterize it

indomalaya <- vect(here(HWC_data, "/R_files/R_output_data/indomalay_region/indomalay_region.shp"))

indomalaya_rast <- rasterize(indomalaya, lulc) ### What is this used for?

# mask lulc to africa extent

lulc_indomalaya <- mask(lulc, indomalaya)

# test plot

plot(lulc_indomalaya)
```

```{r}
#save the file to the drive

writeRaster(lulc_indomalaya, filename = here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/cropped_lulc/lulc_asia.tif"), filetype = "GTiff")
```


```{r}
# read in lulc data

lulc_asia <- rast(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/cropped_lulc/lulc_asia.tif"))
                       
# filter just for cropland by reclassifying (cropland is 1, everything else is 0)

asia_cropland <- lulc_asia

asia_cropland[asia_cropland != 5] <- 0
asia_cropland[asia_cropland == 5] <- 1

# test plot

plot(asia_cropland)

# aggregate cropland 

asia_cropland_agg <- terra::aggregate(asia_cropland, fact = 10, fun = mean, na.rm = TRUE)

plot(asia_cropland_agg)

# save raster for aggregated cropland
writeRaster(asia_cropland_agg, filename = here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/lulc_formatted/lulc_aggregated/asia_cropland_agg.tif"))

# max value: 1
```

```{r}
# calculate deciles
decs_crop <- global(asia_cropland_agg, quantile, probs = seq(0, 1, 0.1), na.rm = TRUE)

# save cutoff value for highest decile
topdec_crop <- decs_crop$X90

# keep only the top decile (as in Di Minin et al.)
top10_crop <- asia_cropland_agg

top10_crop[top10_crop < topdec_crop] <- NA

top10_crop[top10_crop >= topdec_crop] <- 1

plot(top10_crop)

# save raster for cropland top decile

writeRaster(top10_crop, filename = here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/lulc_formatted/lulc_top10/top10_crop_asia.tif"))
```

```{r}
# vizualization

#turn off spherical geometry
sf_use_s2(FALSE)

extended_range <- read_sf(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/extended_range/extended_range_asia.shp"))

crop_dens <- (rast(here(HWC_data, "/Geospatial Data/Diminin_Replication_Data/lulc_formatted/lulc_top10/top10_crop_asia.tif")))

# create a basemap

basemap_asia <- ne_countries(
  continent = "Asia",
  scale = "medium", 
  returnclass = "sf") %>% 
  st_transform(crs = crs(crop_dens))  # make sure crs is same as raster

basemap_asia_vect <- basemap_asia %>% 
  vect()

# map crop density
plot(basemap_asia_vect, col = "grey90")
plot(crop_dens, add = TRUE)
```






